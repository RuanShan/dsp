/*! weimob_vshop_admin
*author:<a.b.c@hd3p.com> */
define("dist/goodsv/init",["./classify","$","dist/application/app","validate","./category","./template/category.html","./goods","chosen","./goods_fun"],function(a){"use strict";a("./classify"),a("./category"),a("./goods"),a("./goods_fun")}),define("dist/goodsv/classify",["$","dist/application/app","validate"],function(a){"use strict";var b=a("$"),c=a("dist/application/app"),e=c.config,f=b("#dragClassify"),g=(b("#noClassify"),b("#save_class")),h=b("#nestableMenu");a("validate"),f.length>0&&a.async("nestable",function(){f.nestable({maxDepth:2}),b(".dd-handle a").on("mousedown",function(a){a.stopPropagation()})}),g.on("click",function(){var a=b(this),c=a.data("remote")||a.attr("href");a.button("loading");var g=window.JSON.stringify(f.nestable("serialize"));b.post(c,{data:g}).done(function(b){a.button("reset"),e.issucceed(b)?e.msg.suc(b.message||e.lang.saveSuccess,b.url):e.msg.error(b.message||e.lang.saveError,b.url)}).fail(function(){a.button("reset"),e.msg.info(e.lang.exception,d.url)})}),h.on("click",function(){var a=b(this).hasClass("active");f.nestable(a?"expandAll":"collapseAll")}),b(document).on("click",".js_source",function(){var a=b(this),c=b(".js_source_hide");a.hasClass("js_source_show")?c.removeClass("hide"):c.addClass("hide")}),b(document).on("click",".js_delivery_city",function(){var a=b(".js_delivery_type").val();0==a.length&&(e.msg.info("请先选择发货地的类型!"),b(".js_delivery_type").focus())}),b(document).on("change",".js_delivery_type",function(){var a=b(this),c=a.val(),d=(b(".js_delivery_city"),b("select.js_delivery_city")),f=(b(".js_delivery_Country"),b("select.js_delivery_Country")),g=b(".js_subjects"),h=(b(".js_subjects2"),window.goods_setting.deliveryLocation_path),i=window.goods_setting.deliveryLocationHai_path,j=(a.closest("form"),a.find("option:selected").data("type"));return h=h+"?type="+c,i=i+"?type="+c,"js_City"==j?(b(".js_rj").addClass("hide"),b(".js_bs").removeClass("hide")):"js_Country"==j&&(b(".js_rj").removeClass("hide"),b(".js_bs").addClass("hide"),b.ajax({url:i,type:"get",dataType:"json"}).done(function(a){if(0==a.status){var c=a.data,d=a.ids,g=d?d.join(","):"";d.length>0&&f.attr("data-ids",g),f.empty(),f.append('<option value="">请选择</option>'),b.each(c,function(a,b){var c=template("delivery_hai_tem",b);f.append(c)})}else e.msg.info(a.message)}).fail(function(){e.msg.info("网络异常")})),d.empty().val(""),b("div.js_delivery_city .select2-chosen").text(""),g.empty(),d.removeAttr("data-ids"),0==j.length?(d.attr("disabled","disabled"),void b("select.js_delivery_Country").attr("disabled","disabled")):(d.removeAttr("disabled"),b("select.js_delivery_Country").removeAttr("disabled"),void b.ajax({url:h,type:"get",dataType:"json"}).done(function(a){if(0==a.status){var c=a.data,f=a.ids,g=f?f.join(","):"";f.length>0&&d.attr("data-ids",g),d.empty(),d.append('<option value="">请选择</option>'),b.each(c,function(a,b){var c=template("delivery_city_tem",b);d.append(c)})}else e.msg.info(a.message)}).fail(function(){e.msg.info("网络异常")}))}),b(document).on("change","select.js_delivery_city",function(){{var a=b(this),c=String(a.val()),d=a.attr("data-ids").split(","),f=b(this).closest(".form-group").find(".js_subjects"),g=b('<select class="form-control" name="subcity" data-toggle="select2" data-rule-required="true"></select>'),h=window.goods_setting.deliveryLocationSub_path;a.closest("form")}if(h=h+"?type="+c,0==c.length)return f.empty(),void f.addClass("hide");for(var i=0;i<d.length;i++)if(c==d[i])return f.empty(),void f.addClass("hide");b.ajax({url:h,type:"get",dataType:"json"}).done(function(a){if(0==a.status){var c=a.data;f.empty(),g.append('<option value="">请选择</option>'),b.each(c,function(a,b){var c=template("delivery_city_tem",b);g.append(c)}),f.append(g),f.removeClass("hide")}else e.msg.info(a.message)}).fail(function(){e.msg.info("网络异常")})}),b(document).on("change","select.js_delivery_Country",function(){{var a=b(this),c=String(a.val()),d=a.attr("data-ids").split(","),f=b(this).closest(".form-group").find(".js_subjects2"),g=b('<select class="form-control" name="subcity2" data-toggle="select2" data-rule-required="true"></select>'),h=window.goods_setting.deliveryLocationhaisub_path;a.closest("form")}if(h=h+"?type="+c,0==c.length)return f.empty(),void f.addClass("hide");for(var i=0;i<d.length;i++)if(c==d[i])return f.empty(),void f.addClass("hide");b.ajax({url:h,type:"get",dataType:"json"}).done(function(a){if(0==a.status){var c=a.data;f.empty(),g.append('<option value="">请选择</option>'),b.each(c,function(a,b){var c=template("delivery_hai2_tem",b);g.append(c)}),f.append(g),f.removeClass("hide")}else e.msg.info(a.message)}).fail(function(){e.msg.info("网络异常")})}),b(document).on("click",".js_save_submit",function(){var a=b(".js_bs select.js_delivery_city").val(),c=b(".js_rj select.js_delivery_city").val(),d=b(".js_rj select.js_delivery_Country").val(),f=b(".js_delivery_type").find("option:selected").data("type");if("js_City"==f){if(void 0!=a&&0==a.length)return e.msg.info("请选择发货地的城市或国家！"),!1}else if("js_Country"==f){if(void 0!=c&&0==c.length)return e.msg.info("请选择入境口岸！"),!1;if(void 0!=d&&0==d.length)return e.msg.info("请选择发货地的城市或国家！"),!1}}),b.validate.addMethod("isGreatThanPrev",function(a,c){var d=b(".js_salesprice"),e=d.val(),f=parseFloat(a);return e?parseFloat(e):0,console.log(f,e),this.optional(c)||f>e},"市场价不能低于销售价!"),b.validate.addMethod("isGreatThanPrev2",function(a,c){var d=b(c).parent().prev().find("input"),e=d.val(),f=parseFloat(a);return e?parseFloat(e):0,console.log(f,e),this.optional(c)||f>e},"市场价不能低于销售价!")}),define("dist/goodsv/category",["$","dist/application/app"],function(a){"use strict";function b(){var a=d(),b=f.inArray(a.selectid,e());b>-1?c(!1,!0):c(!0,!1)}function c(a,b){var c=f(".js_add_common_category"),d=f(".js_used_category");a?c.removeClass("hide"):c.addClass("hide"),b?d.removeClass("hide"):d.addClass("hide")}function d(){var a="",b="",c=[],d=[];return f(".category_item_wrp").each(function(){var a=f(this),b=a.find("li.selected");a.is(":hidden")||b.attr("wid")&&(c.push(b.attr("wid")),d.push(b.find("a").attr("title")))}),a=c.join(","),b=d.join(">"),{selectid:a,selectname:b}}function e(){var a=f(".js_category_lsit_div"),b=[];return a.find("ul.category-dropdown-select li").each(function(){var a=f(this).data("id");a&&b.push(a+"")}),b}var f=a("$"),g=a("dist/application/app"),h=g.config,i=g.method,j=f("div.category_item_wrp");if(window.category&&(window.category.automatic=!0),j.length>0){var k=f('button[type="submit"]'),l=f('[data-toggle="category"]'),m=a("dist/goodsv/template/category.html"),n=h.empty,o=function(a){this.element=a,this.category_items=this.element.find("ul.category_items"),this.data=null;var b=this;f(".input_search",this.element).on("keyup propertychange",function(){b.search(f(this).val().trim())})};o.prototype.init=function(a,b){if(this.data=a,this.childs(a,this),b(),window.category.selected){var c=f('li[wid="{0}"] a'.format(window.category.selected[0]),this.element);if(c.length>0)return c.trigger("click",this),c.closest("ul").scrollTop(c.position().top-100),!0}},o.prototype.search=function(a){this.category_items.find("li").each(function(){var b=f(this);b.text().indexOf(a)>-1?b.show():b.hide()})},o.prototype.childs=function(a,b){if(a&&a.length>0){var c=new StringBuilder;if(f.each(a,function(a,b){c.Append(m.format(b.key,b.val))}),this.category_items.html(c.toString()),b.show(),window.category.selected&&window.category.automatic)for(var d=1;d<window.category.selected.length;d++){var e=f('li[wid="{0}"] a'.format(window.category.selected[d]),this.element);if(e.length>0)return e.trigger("click"),e.closest("ul").scrollTop(e.position().top-100),!0}}else k.removeAttr("disabled"),n=k.data("remote").format(f(".category_item_wrp:visible .selected").last().find("a").data("id"))},o.prototype.hide=function(){this.element.hide()},o.prototype.show=function(){this.element.show()},o.prototype.text=function(){return f(".selected",this.category_items).text()};var p=function(){var a=[],b=f(".category_item_wrp:visible .selected");f.each(b,function(){a.push(f(this).text())}),f(".js_selected_text").html(a.join(">"))},q=new Array;f.each(l,function(a,b){q.push(new o(f(b)))});var r=q.slice(1);q[0].init(window.category.data,function(){f("li a",q[0].category_items).on("click",function(a,c){var d=f(this),e=d.data("id");d.parent().addClass("selected").siblings().removeClass("selected");for(var g=r.length-1;g>=0;g--)r[g].hide();p(),k.attr("disabled","disabled"),i.get(window.category.url.format(e),function(a){q[1].childs(a,q[1])}),c||(window.category.automatic=!1),b()})});for(var s=1;s<q.length;s++)q[s].element.attr("index",s),f(q[s].category_items).on("click","li a",function(){var a=f(this),c=a.data("id"),d=a.parents("div.category_item_wrp"),e=d.next(),g=e.attr("index");a.parent().addClass("selected").siblings().removeClass("selected"),d.nextAll().hide(),p(),k.attr("disabled","disabled"),q[g]?i.get(window.category.url.format(c),function(a){q[g].childs(a,e)}):(k.removeAttr("disabled"),n=k.data("remote").format(f(".category_item_wrp:visible .selected").last().find("a").data("id"))),b()});k.on("click",function(){n.length>0&&h.msg.redirect(n)})}f(document).on("click",".js_add_common_category",function(){var a=f(this),b=a.data("path"),e=d(),g=f(".js_category_lsit_div"),j=g.find("ul.category-dropdown-select");b&&i.post(b,function(a){h.issucceed(a)?(g.find("span.category-dropdown-label").html(e.selectname),j.find("li").removeClass("active"),f(template("js_addcategory_temp",{id:e.selectid,name:e.selectname})).insertAfter(j.find("li:first")),h.msg.info(a.message||h.lang.saveSuccess),c(!1,!0)):h.msg.error(a.message)},"网络错误",!1,{id:e.selectid,name:e.selectname})}),f(document).on("click",".js_category_del",function(){var a=f(this),b=a.data("path"),d=f(".js_category_lsit_div"),e=a.closest("li"),g=e.data("id");b&&i.post(b,function(a){h.issucceed(a)?(e.hasClass("active")&&(d.find("span.category-dropdown-label").html("选择常用类目"),c(!0,!1)),e.remove(),h.msg.info(a.message||h.lang.removeSuccess)):h.msg.error(a.message)},"网络错误",!1,{id:g})})}),define("dist/goodsv/template/category.html",[],'<li wid="{0}"><a href="javascript:;" data-id="{0}" title="{1}">{1}</a>\n</li>\n'),define("dist/goodsv/goods",["$","dist/application/app","chosen"],function(a){"use strict";function b(a,b,d,e,f){function g(b){c(a+":eq("+b+")").on("click",function(){h(b)})}function h(a){for(var g=0;b>g;g++)a==g?(c(d+" ."+e+g).attr("disabled",!1),c(d+" ."+f+g).attr("checked",!0)):(c(d+" ."+e+g).attr("disabled",!0),c(d+" ."+f+g).attr("checked",!1))}for(var i=0;b>i;i++){new g(i);var j=c(a+":eq("+i+") .ui-wizard-content").attr("checked");j&&h(i)}}var c=a("$"),d=a("dist/application/app"),e=d.config,f=d.method;a("chosen");var g=c('[data-toggle="attribute"]');window.goods_data?(template.helper("attribute_selected",function(a,b){return c.isArray(window.goods_data.attributes[a])?c.inArray(b,window.goods_data.attributes[a])>-1?'checked="checked"':e.empty:window.goods_data.attributes[a]==b?'checked="checked"':e.empty}),template.helper("attribute_checked",function(a,b){return c.isArray(window.goods_data.attributes[a])?c.inArray(b,window.goods_data.attributes[a])>-1?'class="active"':e.empty:window.goods_data.attributes[a]==b?'class="active"':e.empty}),template.helper("attribute_disabled",function(){return window.goods_data.shelves?'disabled="disabled"':e.empty}),template.helper("specifications_checked",function(a,b){return c.inArray(b,window.goods_data.specifications[a])>-1?'checked="checked"':e.empty})):(template.helper("attribute_selected",function(){return e.empty}),template.helper("specifications_checked",function(){return e.empty}),template.helper("attribute_disabled",function(){return e.empty}));var h=function(a){var b=[];f.get(window.goods_setting.attribute_path,function(a){a.shelves=window.goods_data.shelves,g.html(template("attribute_template",a)),c(".js_custom_list_contair dl").each(function(){var a=c(this),d=a.find("ul:first"),e=d.attr("id"),f=d.find("li.active input[type='radio']:checked").data("title");if(c("#label_"+e).data("text",f),c("#label_"+e).html(f),"checkbox"==a.find("ul.dropdown-menu").data("type")){var g,h,i=c("#label_"+e);g=a.find("li > a > input:checked"),g.length?(h=[],g.each(function(){var a=c(this).data("title");a&&h.push(c.trim(a))}),b=h,i.data("text",h.join(",")),h=h.length<6?h.join(","):" 选中"+h.length+"项",i.html(h)):i.html(i.data("placeholder"))}})},e.lang.attributeError),a.customInput(),c(document).on("click",".js_custom_list_save",function(){var b=c(this).parents(".js_custom_list").find(".js_custom_input"),d=c(this).data("name"),f=a.customdata(b);a.customAttrValvali(b)&&b.val()&&(a.getAttrValExist(b.val(),f.attrid)?e.msg.info("已经存在的属性值"):a.addAttrVal(f,d,b,!1,c(this))),b.val()||e.msg.error("属性值为空！")}),c(document).on("click",".js_custom_list_cancel",function(){c(this).parents(".js_custom_list").next(".js_custom_list").removeClass("hide"),c(this).parents(".js_custom_list").addClass("hide")}),c(document).on("click",".js_custom_btn",function(){c(this).parents(".js_custom_list").prev(".js_custom_list").removeClass("hide"),c(this).parents(".js_custom_list").addClass("hide");var a=c(this).parents(".custom-select");a.scrollTop(a.get(0).scrollHeight-0+60)}),c(document).on("click",".js_custom_del",function(){var d=c(this).closest("ul.dropdown-menu").data("type"),g=c(this).closest("ul.dropdown-menu"),h=g.attr("id"),i=c(this).prev("a").find("input[type='"+d+"']"),j=i.val();f.post(window.goods_setting.custom_attrvalue_del_path,function(d){if(e.issucceed(d)){if("checkbox"==g.data("type")){var f,j,k=c("#label_"+h);return i.parents("li").remove(),f=g.find("li > a > input:checked"),f.length?(j=[],f.each(function(){var a=c(this).data("title");a&&j.push(c.trim(a))}),b=j,k.data("text",j.join(",")),j=j.length<6?j.join(","):" 选中"+j.length+"项",k.html(j)):k.html(k.data("placeholder")),void e.msg.info(d.message||e.lang.removeSuccess)}i.prop("checked")?c("#label_"+d.data.attrid).html("选择"):a.getAttrValExist(c("#label_"+d.data.attrid).text(),d.data.attrid)||c("#label_"+d.data.attrid).html("选择"),i.parents("li").remove(),e.msg.info(d.message||e.lang.removeSuccess)}else e.msg.error(d.message)},e.lang.attributeError,!1,{attrid:i.data("id"),attrvalid:j})}),c(document).on("click",".js_add_attr_save",function(){var b=c(this),d=c(this).parents(".js_add_attr_form"),f=d.find(".js_add_attr_input"),g=d.find(".js_add_attrv_input"),h=a.customAttrValvali(f),i=a.customAttrValvali(g);if(h&&i&&f.val()&&g.val()){var j=a.getAttrExist(f.val(),"custom-attr-dl-horizontal");if(j.flag)if(a.getAttrValExist(g.val(),j.id))e.msg.info("已经存在的属性和属性值");else{var k=c("#"+j.id).find("input[type='radio']").attr("name");a.addAttrVal({attrid:j.id,attrval:g.val()},k,g,!0,c(this))}else b.data("loadingText",'<i class="fa fa-spinner fa-spin"></i>提交中'),b.button("loading"),c.ajax(window.goods_setting.custom_attr_path,{type:"post",data:{attrname:f.val(),attrvalname:g.val()},dataType:"json"}).done(function(d){b.button("reset"),e.issucceed(d)?(d.data.index=c(".js_custom_list_contair dl").length,a.attrresult(d.data,g,"js_custom_list_contair"),e.msg.info(d.message)):e.msg.error(d.message)}).fail(function(){b.button("reset"),e.msg.info(e.lang.attributeError)})}else e.msg.error("请修改属性或属性值不正确的填写！");f.val()||g.val()?f.val()?g.val()||e.msg.error("属性值为空！"):e.msg.error("属性为空！"):e.msg.error("属性和属性值为空！")}),c(document).on("click",".js_custom_attr_del",function(){var a=c(this);e.msg.msgbox.confirm("确定删除整个分组吗？",function(b){b&&f.post(window.goods_setting.custom_attr_del_path,function(a){if(e.issucceed(a)){var b=c("#"+a.data.attrid).parents("dl"),d=b.index(),f=b.nextAll("dl");b.remove(),f.each(function(a){c(this).find("input[type='hidden']").attr("name","attribute["+(d+a)+"].id"),c(this).find("input[type='radio']").attr("name","attribute["+(d+a)+"].selected"),c(this).find(".js_custom_list_save").attr("data-name","attribute["+(d+a)+"].selected")}),e.msg.info(a.message||e.lang.removeSuccess)}else e.msg.error(a.message)},e.lang.attributeError,!1,{attrid:a.data("id")})})}),c(document).on("click",".js_add_attr_btn",function(){c(".js_add_attr").addClass("hide"),c(".js_add_attr_form").removeClass("hide")}),c(document).on("click",".js_add_attr_cancel",function(){a.closeAttrForm()}),c(document).on("click","dd li",function(){c(this).find("input[type='radio']").length>0&&(c(this).closest("li").show(),c(this).closest("dd").find(".js_custom_dropdown_label").removeClass("error"))}),c(document).on("click",".js_custom_dropdown_label",function(){var a=c(this),d=a.data("id"),e=a.html(),f=c("#"+d).data("type");if("选择"==e)a.html(""),c("#"+d).find("li").show();else{var g=0,h=[];if(c("#"+d).find("input[type='"+f+"']").each(function(){if(c(this).prop("checked")){var a=c(this).text();a&&h.push(c.trim(a)),c(this).data("text",h.join(",")),g=1}}),g&&c("#"+d).find("li").show(),"checkbox"==f&&c(this).data("text")){c(this).html("");var i=c(this).data("text").split(",");b=i,c("#"+d).find("input[type='"+f+"']").each(function(){for(var a=0;a<i.length;a++)i[a]==c(this).data("title")&&(c(this).attr("checked","checked"),c(this).closest("li").addClass("active"))})}}return"block"==c("#"+d).css("display")?!1:void 0}),c("body").on("blur",".js_custom_dropdown_label",function(){{var a=c(this).data("id"),d=c(this).html(),e=c("#"+a).data("type");c(this).data("text")}if(d){if("选择"!=d){var f=0,g=[];c("#"+a).find("input[type='radio']").each(function(){c(this).prop("checked")&&(c(this).data("title")==d?f=1:(c(this).removeAttr("checked"),c(this).parent().parent().removeClass("active")))}),"checkbox"==c(this).closest("a.dropdown-toggle").next("ul.dropdown-menu").data("type")&&(c("#"+a).find("input[type='checkbox']").each(function(){c(this).prop("checked")&&g.push(c(this).data("title"))}),b.join(",")==g.join(",")?f=1:(f=0,c("#"+a).find("input[type='checkbox']").each(function(){c(this).removeAttr("checked"),c(this).parent().parent().removeClass("active")}))),f?c(this).removeClass("error"):c(this).addClass("error")}}else{if("checkbox"==c("#"+a).data("type")){var h,i,j;return h=c("#"+a).find("li > a > input:checked"),j=c("#"+a).parent().find(".dropdown-label"),void(h.length?(i=[],h.each(function(){var a=c(this).data("title");a&&i.push(c.trim(a))}),j.data("text",i.join(",")),i=i.length<6?i.join(","):" 选中"+i.length+"项",j.html(i)):j.html(j.data("placeholder")))}c(this).html("选择"),c("#"+a).find("input[type='"+e+"']").each(function(){c(this).removeAttr("checked"),c(this).parent().parent().show(),c(this).parent().parent().removeClass("active")}),c(this).removeClass("error")}}),c(document).on("keyup",".js_custom_dropdown_label",function(){var d=c(this).data("id"),e=c(this).text(),f=c("#"+d).find(".js_search_result");c(this).data("text",e);var g=(c(this).data("text"),a.attrValSearch(e,d,b));g?f.addClass("hide"):(f.find("a").html("未找到"+e),f.removeClass("hide"))})},i=c('[data-toggle="specifications"]'),j=c("div.specificationstable"),k=c("div.nospecifications"),l=function(){this.specVals=null,this.SpecificationsList=null,this.TableData={ths:[]},this.specificationstable=c('[data-toggle="specificationstable"]');{var a=this;c('[data-toggle="specvals"]')}c('[data-toggle="specification-enable"]').on("click",function(){var a=c(this).data("enable");i.toggle(a),a?(j.show(),k.hide()):(j.hide(),k.show())});var b=c('[data-toggle="specification-enable"]:checked').data("enable");b?(i.show(),j.show(),k.hide()):k.show(),f.get(window.goods_setting.specifications_path,function(d){a.SpecificationsList=d.data,c.each(d.data,function(b,c){a.TableData.ths.push(c)}),i.html(template("specifications_template",d)),a.init(),b&&a.acquire()},e.lang.specificationsError)},m=function(){};m.prototype.getAttrExist=function(a,b){var d,e,f=[],g="";return c("."+b).find("dt").each(function(){c(this).data("title")&&f.push(c(this).data("title"))}),e=c.inArray(a,f),d=0>e?!1:!0,g=c("."+b).find("dt").eq(e).data("id"),{flag:d,id:g}},m.prototype.getAttrValExist=function(a,b){var d,e,f=[];return c("#"+b).find("input[type='radio']").each(function(){c(this).val()&&f.push(c(this).data("title"))}),e=c.inArray(a,f),d=0>e?!1:!0},m.prototype.attrValSearch=function(a,b,d){var e=0,f=c("ul#"+b).data("type");return c("#"+b).find("input[type='"+f+"']").each(function(){var b=c(this),g=b.data("title")||"选择",h=b.parent().parent();g&&(g+="",g.indexOf(a)>-1?(e++,h.show()):h.hide()),"checkbox"==f&&c.map(d,function(a){b.data("title")==a&&(b.attr("checked","checked"),b.closest("li").css("display","block").addClass("active"))})}),e},m.prototype.getSpevalExist=function(a,b){var d,e,f=[];return c("#specvals_show_"+b).find(".js_specvals_show").each(function(){f.push(c(this).data("name"))}),e=c.inArray(a,f),d=0>e?!1:!0},m.prototype.spevalExist=function(a,b){var d,e=[],f=this.getSpelist(a).arrval,g="";return c("#specvals_show_"+b).find(".js_specvals_show").each(function(){e.push(c(this).data("name"))}),c(f).each(function(a,b){d=c.inArray(b,e),d>-1&&(g+=b+",")}),g},m.prototype.getnSpevalExist=function(a){var b,d,e=[];return c(".js_spe_spev_show").find(".js_specvals_show").each(function(){e.push(c(this).data("name"))}),d=c.inArray(a,e),b=0>d?!1:!0},m.prototype.addAttrVal=function(a,b,d,f,g){var h=this;g.data("loadingText",'<i class="fa fa-spinner fa-spin"></i>提交中'),g.button("loading"),c.ajax(window.goods_setting.custom_attrvalue_path,{type:"post",data:a,dataType:"json"}).done(function(a){g.button("reset"),e.issucceed(a)?(a.data.checked=!0,a.data.name=b,"radio"==g.closest("ul.dropdown-menu").data("type")?h.result(a.data,d,f):"checkbox"==g.closest("ul.dropdown-menu").data("type")&&h.resultCheckbox(a.data,d,f)):e.msg.error(a.message)}).fail(function(){g.button("reset"),e.msg.info(e.lang.attributeError)})},m.prototype.closeAttrForm=function(){c(".js_add_attr").removeClass("hide"),c(".js_add_attr_form").addClass("hide")},m.prototype.attrresult=function(a,b,d){var f=c("."+d).find("dl:last");f.length?c(template("customattr_tem",a)).insertAfter(f):c(template("customattr_tem",a)).insertBefore(c("."+d).find(".line-dashed:first")),b.val(""),b.next(".js_limit").find("em").html(0),c(".js_add_attr_input").val(""),c(".js_add_attr_input").next(".js_limit").find("em").html(0),this.closeAttrForm(),e.msg.info(e.lang.saveSuccess)},m.prototype.result=function(a,b,d){var f=c("#"+a.attrid).find(".js_custom_list:first");c("#"+a.attrid).find("li").removeClass("active"),c("#"+a.attrid).find("li input[type='radio']").removeAttr("checked"),a.type="radio",c(template("customattrval_tem",a)).insertBefore(f),c("#label_"+a.attrid).html(a.title),c("#label_"+a.attrid).removeClass("error"),c(document).trigger("click"),b.val(""),b.next(".js_limit").find("em").html(0),d?(c(".js_add_attr_input").val(""),c(".js_add_attr_input").next(".js_limit").find("em").html(0),this.closeAttrForm()):(f.addClass("hide"),f.next(".js_custom_list").removeClass("hide")),c("#"+a.attrid).find(".js_search_result").addClass("hide"),e.msg.info(e.lang.saveSuccess)},m.prototype.resultCheckbox=function(a,b,d){var f,g,h=c("#"+a.attrid).find(".js_custom_list:first"),i=c("#label_"+a.attrid),j=c("#"+a.attrid);a.type="checkbox",c(template("customattrval_tem",a)).insertBefore(h),b.val(""),b.next(".js_limit").find("em").html(0),f=j.find("li > a > input:checked"),f.length?(g=[],f.each(function(){var a=c(this).data("title");a&&g.push(c.trim(a))}),i.data("text",g.join(",")),g=g.length<6?g.join(", "):" 选中"+g.length+"项",i.html(g)):i.html(i.data("placeholder")),d?(c(".js_add_attr_input").val(""),c(".js_add_attr_input").next(".js_limit").find("em").html(0),this.closeAttrForm()):(h.addClass("hide"),h.next(".js_custom_list").removeClass("hide").removeClass("active")),c("#label_"+a.attrid).removeClass("error"),c("#"+a.attrid).closest("dd").removeClass("open"),c("#"+a.attrid).find(".js_search_result").addClass("hide"),e.msg.info(e.lang.saveSuccess)},m.prototype.customAttrValvali=function(a){var b=!0,c=a.data("limit")-0,d=this.getInputLen(a);return b=d>2*c?!1:!0},m.prototype.customInput=function(){var a=this;c(document).on("keyup",".js_custom_input",function(){var b=a.getInputLen(c(this)),d=c(this).data("limit")-0,e=c(this).next(".js_limit");e.find("em").html(Math.ceil(b/2)),b>2*d?e.addClass("error"):e.removeClass("error")})},m.prototype.getInputLen=function(a){return a.val().replace(/[^\x00-\xff]/g,"xx").length},m.prototype.customdata=function(a){return{attrid:a.data("id"),attrval:a.val()}},m.prototype.getSpelist=function(a){var b=[],d=[];return a.find(".js_specvals_temp").each(function(){b.push(c(this).data("name"))}),a.find(".js_specvals_del .js_del_specvals_val_list").each(function(){d.push(c(this).data("id"))}),{arrval:b,idarr:d}},m.prototype.saveSpeval=function(a,b){var d=this;b.data("loadingText",'<i class="fa fa-spinner fa-spin"></i>提交中'),b.button("loading"),c.ajax(window.goods_setting.custom_spevalue_path,{type:"post",data:a,dataType:"json"}).done(function(a){b.button("reset"),e.issucceed(a)?(d.resultSpeval(a.data),e.msg.info(a.message||e.lang.removeSuccess)):e.msg.error(a.message)}).fail(function(){b.button("reset"),e.msg.info(e.lang.attributeError)})},m.prototype.saveSpe=function(a,b){var d=this;b.data("loadingText",'<i class="fa fa-spinner fa-spin"></i>提交中'),b.button("loading"),c.ajax(window.goods_setting.custom_spe_path,{type:"post",data:a,dataType:"json"}).done(function(a){b.button("reset"),e.issucceed(a)?(d.resultSpe(a.data),c(".js_nospe_tips").addClass("hide"),e.msg.info(a.message||e.lang.removeSuccess)):e.msg.error(a.message)}).fail(function(){b.button("reset"),e.msg.info(e.lang.attributeError)})},m.prototype.delSpeval=function(a){var b=this;c.ajax(window.goods_setting.custom_delspevalue_path,{type:"post",data:a,dataType:"json"}).done(function(a){e.issucceed(a)?(b.resultdelSpeval(a.data),n.SpecificationsListskey().delspvals(a.data.speid,a.data.spevalidList),e.msg.info(a.message||e.lang.removeSuccess)):e.msg.error(a.message)}).fail(function(){e.msg.info(e.lang.attributeError)})},m.prototype.resultSpeval=function(a){var b=a.speid,d=c("#specvals_"+b),e=c("#specvals_show_"+b).find("div");d.append(template("specv_tem",a)),this.closeopen(b,!0),e.find(".js_specvals_temp").remove(),e.append(template("specv_result_tem",a))},m.prototype.resultSpe=function(a){c(template("spe_result_tem",a)).insertBefore(c(".js_add_spe_div"));var b={id:a.id,name:a.name,all_val:a.spevalList};n.SpecificationsList.push(b),n.TableData.ths.push(b),n.acquire(),c(".js_add_spe_input").val(""),c(".js_add_spe_input").next(".js_limit").find("em").html(0),c(".js_spe_spev_show").find(".js_specvals_temp").remove(),this.specloseopen(!0)},m.prototype.resultdelSpeval=function(a){var b=a.speid,d=c("#specvals_"+b),e=c("#specvals_show_"+b).find("div");this.closeopen(b,!0),c(a.spevalidList).each(function(a,b){d.find("#spe_"+b).remove()}),e.find(".js_specvals_del").remove()},m.prototype.closeopen=function(a,b){c("#specvals_ed_"+a).toggleClass("hide",b),c("#js_specifications_"+a).toggleClass("hide",!b),c(".js_add_spe_div,.js_specifica_edit,.js_specifica_del").toggleClass("hide",!b)},m.prototype.specloseopen=function(a){c(".js_add_spe_form").toggleClass("hide",a),c(".js_add_spe_div,.js_specifica_edit,.js_specifica_del").toggleClass("hide",!a)},m.prototype.getSpeExist=function(a){var b,d,e=[],f="";return c("[data-toggle='specifications']").find(".js_specifica").each(function(){c(this).data("name")&&e.push(c(this).data("name"))}),d=c.inArray(a,e),b=0>d?!1:!0,f=c("[data-toggle='specifications']").find(".js_specifica").eq(d).data("id"),{flag:b,id:f}},l.prototype.acquire=function(){this.selectSpecifications_vals=new Array;var a=this;a.TableData.ths=[],c.each(this.SpecificationsList,function(b,d){var e=d.id,f=c("#specvals_"+e).find('[type="checkbox"]:checked'),g=new Array;c.each(f,function(a,b){g.push({val:b.title,key:b.value})});var h=g.length>0;h&&a.TableData.ths.push(d),h&&a.selectSpecifications_vals.push(g)}),this.showtable=this.selectSpecifications_vals.length,this.showtable&&this.generate(),this.showtable||this.specificationstable.html('<span class="help-block">请选择规格</span>')},l.prototype.generate=function(){this.res=this.combine(this.selectSpecifications_vals.reverse()),this.rowspan(),this.TableData.trs=[];var a=this;c.each(this.res,function(b,d){var e=[],f=[];c.each(d,function(c,d){var g=[];g.rowspan=a.row[c],g.key=d.key,g.val=d.val,g.index=b,e.push(g),f.push(d.key)});var g=f.join(":"),h={tds:e,index:b,key:g};if(a.changeval(g),window.goods_data||(window.goods_data={products:{}}),window.goods_data&&window.goods_data.products){var i=window.goods_data.products[g];i&&(h=c.extend({},h,i))}a.TableData.trs.push(h)}),this.specificationstable.html(template("specifications_table_template",this.TableData)),j.show()},l.prototype.changeval=function(a){!window.goods_data.products[a]&&(window.goods_data.products[a]={}),c(document).on("change",'[data-id="'+a+'"]',function(){var a=c(this),b=a.data("id"),d=a.data("name"),e=c('[data-id="'+b+'"]'),f={};c.each(e,function(){var b={},e=a.val();b[d]=e,f=c.extend({},f,b)});var g=a.closest("tr").siblings().find('[data-name="'+d+'"]');a.valid()&&c.each(g,function(){var b=c(this);b.val().length<1&&(b.hasClass("js_no_auto_write")||(b.val(a.val()),b.valid()))}),window.goods_data.products[b]=f})},l.prototype.rowspan=function(){for(var a=[],b=this.res.length,c=this.selectSpecifications_vals.length-1;c>-1;c--)a[c]=parseInt(b/this.selectSpecifications_vals[c].length),b=a[c];this.row=a.reverse()},l.prototype.refresh=function(){var a=this;a.TableData.ths=[],c.each(a.SpecificationsList,function(b,c){a.TableData.ths.push(c)}),this.acquire()},l.prototype.SpecificationsListskey=function(){var a=this;return{delsp:function(b){for(var c=[],d=0,e=a.SpecificationsList.length;e>d;d++)a.SpecificationsList[d].id!=b&&c.push(a.SpecificationsList[d]);a.SpecificationsList=c,a.refresh()},delspvals:function(b,c){for(var d=0,e=a.SpecificationsList.length;e>d;d++)if(a.SpecificationsList[d].id==b){for(var f=[],g=0,h=a.SpecificationsList[d].all_val.length;h>g;g++)for(var i=0,j=c.length;j>i;i++)a.SpecificationsList[d].all_val[g].key!=c[i]&&f.push(a.SpecificationsList[d].all_val[g]);a.SpecificationsList[d].all_val=f}a.refresh()}}},l.prototype.combine=function(a){var b=[];return function c(a,d,e){if(0==e)return b.push(a);for(var f=0;f<d[e-1].length;f++)c(a.concat(d[e-1][f]),d,e-1)}([],a,a.length),b},l.prototype.init=function(){var a=this;c(document).on("click",'[data-toggle="specvals"] input[type="checkbox"]',function(){a.acquire()});var b=new m;c(document).on("click",".js_add_speval",function(){var a=c(this).closest(".form-group").find("input"),d=c(this).data("id"),e=a.val();b.customAttrValvali(a)&&e?b.getSpevalExist(e,d)?c("#specvals_error_"+d).html("输入的规格值已存在"):(c("#specvals_error_"+d).html(""),c("#specvals_show_"+d).find("div").append(template("specv_show_tem",{val:e,speid:d})),a.val(""),a.next(".js_limit").find("em").html(0)):c("#specvals_error_"+d).html("请输入规格值，长度不要超过15个字")}),c(document).on("click",".js_spe_speval",function(){var a=c(".js_add_spev_input"),d=a.val();b.customAttrValvali(a)&&d?b.getnSpevalExist(d)?c(".js_js_spe_spev_error").html("输入的规格值已存在"):(c(".js_js_spe_spev_error").html(""),c(".js_spe_spev_show").append(template("specv_show_tem",{val:d,speid:""})),a.val(""),a.next(".js_limit").find("em").html(0)):c(".js_js_spe_spev_error").html("请输入规格值，长度不要超过15个字")}),c(document).on("click",".js_specifica_edit",function(){var a=c(this).data("id");b.closeopen(a,!1),c(".js_add_spe_div,.js_specifica_edit,.js_specifica_del").addClass("hide")}),c(document).on("click",".js_specvals_val_save",function(){var a=c(this).data("id"),d=c(this).closest(".form-group").prev(".form-group"),f=b.getSpelist(d),g=f.arrval,h=f.idarr,i={speid:a,speval:g};g.length>0&&b.saveSpeval(i,c(this)),h.length>0&&b.delSpeval({speid:a,idarr:h},c(this)),g.length<1&&h.length<1&&e.msg.error("请添加规格值或者删除规格值")}),c(document).on("click",".js_specvals_val_cancel",function(){var a=c(this).data("id");b.closeopen(a,!0)}),c(document).on("click",".js_del_specvals_val_list",function(){var a=c(this).data("id");a?c(this).parent().removeClass("js_specvals_result").addClass("hide js_specvals_del"):c(this).parent().remove()}),c(document).on("click",".js_add_spe_btn",function(){b.specloseopen(!1)}),c(document).on("click",".js_add_spe_save",function(){var a=c(".js_add_spe_input").val(),d=(c(".js_add_spev_input").val(),c(".js_spe_spev_show").find(".js_specvals_temp").length),f=b.getSpeExist(a);
if(c(".js_js_spe_spev_error").html(""),a)if(b.customAttrValvali(c(".js_add_spe_input")))if(f.flag)if(d>0){var g=b.spevalExist(c(".js_spe_spev_show"),f.id);if(g.length>0)c(".js_js_spe_spev_error").html("输入的规格值："+g+"已存在");else{var h=f.id,i=c(this).closest(".form-group").prev(".form-group"),j=b.getSpelist(i),k=j.arrval,l=(j.idarr,{speid:h,speval:k});k.length>0&&(b.saveSpeval(l,c(this)),c(".js_add_spe_input").val(""),c(".js_add_spe_input").next(".js_limit").find("em").html(0),c(".js_spe_spev_show").find(".js_specvals_temp").remove(),b.specloseopen(!0))}}else e.msg.error("请添加规格值");else{var m=b.getSpelist(c(".js_spe_spev_show")).arrval,l={spe:a,speval:m};m.length>0?b.saveSpe(l,c(this)):e.msg.error("请添加规格值")}else e.msg.error("规格只能输入5个字请修改规则");else e.msg.error("请添加规格")}),c(document).on("click",".js_add_spe_cancel",function(){b.specloseopen(!0)}),c(document).on("click",".js_specifica_del",function(){var b=c(this).data("id"),d=c(this).data("name");e.msg.msgbox.confirm("确定删除规格："+d+"，及其所属的规格吗？",function(d){d&&f.post(window.goods_setting.custom_spe_del_path,function(b){e.issucceed(b)?(e.msg.info(b.message||e.lang.removeSuccess),c("#js_specifications_"+b.data.speid).remove(),c("#specvals_ed_"+b.data.speid).next(".line-dashed").remove(),c("#specvals_ed_"+b.data.speid).remove(),a.SpecificationsListskey().delsp(b.data.speid),c(".js_specifica").length<1&&c(".js_nospe_tips").removeClass("hide")):e.msg.error(b.message)},e.lang.attributeError,!1,{speid:b})})})},g.length>0&&h(new m);var n;i.length>0&&(n=new l),c(document).on("click",".js_select_all_address",function(){var a=c(this),b=a.prop("checked");c("input[type=checkbox]",c('div[data-toggle="specifications"]')).prop("checked",b),n.acquire()});var o=c(".js_undertake");if(o.length>0){var p=c(".js_freight_container"),q=c(".js_freight_type"),r=c(".js_unify_container"),s=c(".js_template_container"),t=(c(".js_freight_template_loading"),c(".js_freight_template")),u=c(".js_freight_template_refresh"),v=c(".js_freight_item");o.on("click",function(){p.toggle(c(this).hasClass("js_freight_container_show"))}),q.on("click",function(){var a=c(this);r.toggle(a.hasClass("js_unify_container_show")),s.toggle(a.hasClass("js_template_container_show"))}),v.on("click",function(){var a=c(this),b=a.closest("dl");c('input[type="text"]',b).addAttr("disabled",!a.prop("checked"))}),u.on("click",function(a){a&&a.preventDefault();var b=c(this),d=b.data("remote")||b.attr("href"),f=b.find("i");f.addClass("fa-spin");var g=' <option value="{0}">{1}</option>';t.empty(),c.post(d).done(function(a){a.data&&(t.append('<option value="">请选择</option>'),c.each(a.data,function(a,b){t.append(g.format(b.id,b.name))})),f.removeClass("fa-spin"),t.focus()}).fail(function(){f.removeClass("fa-spin"),e.msg.info(e.lang.exception)})}),c(document).on("click",'button[type="submit"]',function(){if(r.is(":visible")){var a=c(".js_freight_item:checked");if(a.length<1)return e.msg.info("至少选择一个运送方式"),!1}})}c(document).on("click",".js_save_submit",function(){var a=[];return 0==c(".js_fileList").length?!0:c(".js_fileList li.imgbox").length<1?(e.msg.error("至少选择一个商品图片"),!1):(c("div.js_custom_list_contair > dl > dd").each(function(){if(c(this).data("required")){var b=c(this).find("span.js_custom_dropdown_label").data("text");if(!b||"选择"==b){var d=c(this).prev("dt").data("title");return a.push(d),e.msg.error("请选择{0}的属性".format(d)),!1}}}),a.length>0||"选择"==a[0]?!1:void 0)}),c(document).on("click",".js_save_submit",function(){var a=c('[data-toggle="specifications"]'),b=a.find("input[type='checkbox']:checked").length;if(0==a.length)return!0;if(!a.is(":hidden")&&1>b)return e.msg.error("至少选择一个商品规格"),!1;var d=c(".chzn-single span").html();return"请选择"==d?(e.msg.error("商品计量单位未选择"),!1):void 0});var w=c(".js_quota");w.on("click",function(){var a=c(this).hasClass("js_quota_show"),b=c(".js_quota_container");b.toggleClass("hd",!a).toggleClass("inline",a)}),c(document).on("click",".js_submit",function(){c(this).closest("form").submit()}),c(document).on("keypress",function(a){var a=a||event,b=a.keyCode||a.which||a.charCode;return 13==b?(c(".js_spe_speval").closest(".js_enter_div").hasClass("hide")||c(".js_spe_speval").trigger("click"),c(".js_add_speval").each(function(){c(this).closest(".js_enter_div").hasClass("hide")||c(this).trigger("click")}),!1):void 0}),c(document).on("click",".js_save_submit",function(){var a=c(this),b=c(this).data("confirm"),d=a.data("confirmMsg");if(b){var f=c("#js_store_way"),g=c(".js_way_select:checked").val();if(0==g&&f.val()!=g)return e.msg.msgbox.confirm({message:d||e.lang.confirmPost,buttons:{confirm:{label:a.data("confirmText")||"确定修改"}},callback:function(b){b&&a.submit()}}),!1}}),c(document).on("click",".js_search_add_submit",function(){var a=c(this).closest("form"),b=a.attr("action"),d=c(".talbe-search").serialize();a.attr("action",b.format(d))}),c(document).on("click",".js_edit_search",function(){var a=c(this),b=a.attr("href"),d=c(".talbe-search").serialize();a.attr("href",b.format(d))});var x=c(".js_brashow select option");x.length<2&&(c(".js_brashow").addClass("hide"),c(".js_brashow").next("div").addClass("hide")),b("#gzgg .radio_br",2,"#gzgg","wpms_","check_"),b("#sl_0 .radio_br",2,"#sl_0","wpms_","check_"),b("#sl_1 .radio_br",2,"#sl_1","wpms_","check_");var y=function(){for(var a=c(this).attr("data-nums"),b=0;b<c("#sls .sp_sl").length;b++)b==a?c("#sl_"+b).show():c("#sl_"+b).hide()};c("#sls .sp_sl").on("click",y);for(var z,A=c("#sls .sp_sl"),B=0;B<A.length;B++){var C=c("#sls .sp_sl:eq("+B+") .ui-wizard-content").attr("checked");C&&(z=c("#sls .sp_sl:eq("+B+")").attr("data-nums"))}for(var B=0;B<c("#sls .sp_sl").length;B++)B==z?c("#sl_"+B).show():c("#sl_"+B).hide()}),define("dist/goodsv/goods_fun",["$","dist/application/app"],function(a){"use strict";function b(a,b){var d=a.data("type"),g=f(".js_goods_pay_type_div"),h=f(".js_goods_pay_type_"+d),i=a.val();g.addClass("hide"),f("input,select",g).prop("disabled",!0),h.removeClass("hide"),f("input,select",h).prop("disabled",!1),e(),c(i,b)}function c(a,b){var c=f(".js_operator_business"),e=c.val(),g=f(".js_operator_value"),i=g.data("selectid"),j=f(".js_value_channel");g.empty(),j.html(""),""!=e?f.ajax(window.goods_setting.face_value_path,{type:"post",data:{type:a,operator:e},dataType:"json"}).done(function(c){h.issucceed(c)?(b&&(c.selectid=i,d(a,e,i)),g.empty(),g.append(template("face_value_list_temp",c))):h.msg.error(c.message)}).fail(function(){h.msg.info(h.lang.exception)}):g.append(template("face_value_list_temp",{}))}function d(a,b,c){var d=f(".js_value_channel");""!=c?f.ajax(window.goods_setting.channel_path,{type:"post",data:{type:a,operator:b,value:c},dataType:"json"}).done(function(a){h.issucceed(a)?d.html(template("channels_list_temp",a)):h.msg.error(a.message)}).fail(function(){h.msg.info(h.lang.exception)}):d.html("")}function e(){f(".js_pay_explan_select").each(function(){var a=f(this),b=a.data("type"),c=a.prop("checked");f("input[type=text]",a.closest(".input-group")).prop("disabled",!0).removeClass("error"),f("span.error",a.closest(".input-group").parent()).remove(),c&&"custom"==b&&f("input[type=text]",a.closest(".input-group")).prop("disabled",!1)})}{var f=a("$"),g=a("dist/application/app"),h=g.config;g.method}window.updateLabel=function(a){var b=f(".js_goods_label");b.append("<option value="+a.key+" selected>"+a.value+"</option>"),b.trigger("liszt:updated"),b.chosen()};var i=f(".js_goods_group");i.find("optgroup").each(function(){f(this).find("option").length<1&&f(this).append("<option style='display:none' value='' data-placeholder='true'>暂无数据</option>")}),i.trigger("liszt:updated"),window.updateGroup=function(a){var b=f(".js_goods_group");"0"!=a.groupId?b.find("#"+a.groupId).append("<option value="+a.key+" selected>"+a.value+"</option>"):b.append("<optgroup id="+a.key+" label="+a.value+"><option value='' data-placeholder='true'>暂无数据</option></optgroup>"),b.find("optgroup").each(function(){f(this).find("option").length>1&&f(this).find("option[data-placeholder]").length>0&&f(this).find("option[data-placeholder]").remove()}),b.trigger("liszt:updated"),f(".chzn-results .group-option").each(function(){"暂无数据"==f(this).text()&&f(this).hide()})},window.updateAddress=function(a){var b=f(".js_address_edit");b.append("<option value="+a.key+" selected>"+a.value+"</option>")},f(document).on("click",".js_goods_pay_type",function(){b(f(this))});var j=f(".js_goods_pay_type:checked");j.length&&function(){b(j,!0)}(),f(document).on("change",".js_operator_business",function(){c(f(".js_goods_pay_type:checked").val())}),f(document).on("click",".js_pay_explan_select",function(){e()}),f(document).on("change",".js_operator_value",function(){d(f(".js_goods_pay_type:checked").val(),f(".js_operator_business").val(),f(this).val())})});