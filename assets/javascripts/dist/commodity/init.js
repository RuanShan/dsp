/*! weimob_vshop_admin
*author:<a.b.c@hd3p.com> */
define("dist/commodity/init",["$","dist/application/app","./template/page.html","./template/template.html","./template/page_stores.html","./template/stores.html","./template/page_stores.html","./template/msg.html","./template/page_stores.html","./template/goods.html"],function(a,b){"use strict";var c=a("$"),e=a("dist/application/app"),f=e.config,g=e.method;b.init=function(b,d,e){function h(){var a=c(".prize-list").not(".hide").find(".js_message");c.each(a,function(a,b){var d=c(b).find("[data-find-name]");c.each(d,function(b,d){var e=c(d).attr("name");e=e.replace(/(\[messages\]\[\d{1,2}\])/,"[messages]["+a+"]"),c(d).attr("name",e)})})}function i(a,b){g.post(a,function(a){if(f.issucceed(a)){var b=a.data.data,d=[],e=a.data.totalPage,g=a.data.currentPage;if(b){for(var h=0,i=b.length;i>h;h++){var j=r.map(function(a){return a.id}).indexOf(b[h].id);j>-1&&(b[h].checked=!0)}if(e>0)if(e-g>=2){var k=1,l=5;k=g-2>0?g-2:1,l=k+4;for(var h=k;l>=h;h++)h>0&&e>=h&&d.push(h)}else{var k=1,l=5;l=e>=g+2?g+2:e,k=l-4;for(var h=k;l>=h;h++)h>0&&e>=h&&d.push(h)}}a.data.pagelist=d,a.data.selected=v.hasClass(s);var n=template.compile(q+t)(a.data);if(v.html(n),!v.hasClass(s)){var i=c("tr.js_dishes_data",v).length,o=c("tr td input[type='checkbox']:checked",v).length,p=c("tr td input[type='checkbox'].disabled",v).length;i>0&&i==o+p&&c(".js_page_goods",m).prop("checked",!0)}}else f.msg.error(a.message)},f.lang.exception,!1,b)}function j(a,b,c,d){if(d)b[0]=a;else if(c){var e=b.map(function(a){return a.id}).indexOf(a.id);e>-1&&b.splice(e,1)}else{var e=b.map(function(a){return a.id}).indexOf(a.id);-1==e&&b.push(a)}}var k=d.data("path"),l=d.data("tmodal"),m=c(l),n=d.data("type"),o=e.target,p=c(d.data("target"),b),q="",r=[],s="newest-selected",t=a("./template/page.html"),q=a("./template/template.html"),u=d.data("pageTemplate"),v=c("#all-list-box",m),w=c("form.search-form",m).serialize();m.unbind("click"),m.modal("show"),i(k,w),"stores"==n&&(t=a("./template/page_stores.html"),q=a("./template/stores.html")),"msg"==n&&(t=a("./template/page_stores.html"),q=a("./template/msg.html")),"goods"==n&&(t=a("./template/page_stores.html"),q=a("./template/goods.html")),c("tr.js_dishes_data",p).each(function(){var a=c(this),b=a.data("id")+"",d=a.data("img"),e=a.data("names"),f=a.data("price");r.push({id:b,img:d,names:e,price:f})}),m.on("click",".js_save_btn",function(){var a=!0,b=c(o),d=b.data("insert"),e=b.closest(".form-group"),g=e.find("img"),i=e.find("input.js_goodid"),j=e.find("span:first"),k=r.map(function(a){return a.id}),l={data:r};if(c("#js_selected_id",m).val(k.join(",")),u)p.html(template(u,l));else if(r.length<1)a=!1,f.msg.error(c(this).data("msg")||"请选择商品");else if(a=!0,1==d){var n=c(".cover_appmsg_item.on").index(),q={img:l.data[0].img,id:l.data[0].id,itemIndex:n,messageIndex:c("#list"+n).find(".js_message").length},s=template("js_insert_good_temp",q);e.after(s),h()}else g.attr("src",l.data[0].img).css("opacity","1"),i.val(l.data[0].id),j.remove(),e.find(".js_input_goodid").removeAttr("data-rule-required").addClass("hide"),e.find(".js_select_good").addClass("hide"),e.find(".js_good_container").removeClass("hide");return a&&m.modal("hide"),!1}),m.on("hidden.bs.modal",function(){v.html('<tr><td colspan="3"><i class="fa fa-spinner fa-spin"></i></td></tr>'),c(".js_page",v.closest("form")).val(1),v.closest("form")[0].reset(),c(document).unbind("keypress")}),m.on("shown.bs.modal",function(){c(document).on("keypress",function(a){var a=a||event,b=a.keyCode||a.which||a.charCode;return 13==b?(c("button[data-type='ajaxSearchs']").each(function(){c(this).is(":hidden")||c(this).trigger("click")}),!1):void 0})}),m.on("click",".js_dishes_checkbox",function(a){a.stopPropagation();var b=c(this),d=b.hasClass("selected"),e=b.hasClass("disabled"),f={id:b.data("id")+"",img:b.data("img"),names:b.data("names"),price:b.data("price")},g=b.closest("form"),h=c(".js_page_goods",g);e||(d?(b.removeClass("selected"),h.prop("checked",!1),v.hasClass(s),j(f,r,!0)):(b.addClass("selected"),j(f,r,!1)))}),m.on("click",".js_dishes_radio",function(a){a.stopPropagation();{var b=c(this),d=(b.hasClass("selected"),b.hasClass("disabled"),{id:b.data("id")+"",img:b.data("img"),names:b.data("names"),price:b.data("price")});b.closest("form")}j(d,r,!0,!0)}),m.on("click",".js_page_goods",function(){var a=c(this),b=a.prop("checked"),d=v.find("tr.js_dishes_data td input[type='checkbox']");d.each(b?function(){var a=c(this),b={id:a.data("id")+"",img:a.data("img"),names:a.data("names"),price:a.data("price")},d=a.hasClass("disabled");d||a.hasClass("selected")||(a.prop("checked",!0),a.addClass("selected"),j(b,r,!1))}:function(){var a=c(this),b={id:a.data("id")+"",img:a.data("img"),names:a.data("names"),price:a.data("price")},d=a.hasClass("disabled");!d&&a.hasClass("selected")&&(a.prop("checked",!1),a.removeClass("selected"),j(b,r,!0))})}),c(document).on("click","button[data-type='ajaxSearch']",function(){var a=c(this),b=a.closest("form"),d=b.data("path"),e=c(".js_page_goods",b),f=c(".js_page",b);f.val(1),e.prop("checked",!1);var g=b.serialize();i(d,g)}),m.on("change","select[data-type='ajaxSelectSearch']",function(){var a=c(this),b=a.closest("form"),d=c(".js_page_goods",b),e=c(".js_page",b);if(e.val(1),d.prop("checked",!1),a.hasClass("js_search_select_type_select")){var f=a.find("option:selected").data("type");c(".js_search_select_type",b).addClass("hide").prop("disabled",!0).find("option").removeAttr("selected"),c(".js_search_select_type_"+f,b).removeClass("hide").prop("disabled",!1)}var g=b.serialize();i(k,g)}),m.on("click","button[data-type='ajaxSearchs']",function(){var a=c(this),b=a.closest("form"),d=c(".js_page_goods",b),e=c(".js_page",b);e.val(1),d.prop("checked",!1);var f=b.serialize();i(k,f)}),m.on("click","input[data-type='ajaxSearchs']",function(){var a=c(this),b=a.closest("form"),d=c(".js_page_goods",b),e=c(".js_page",b);e.val(1),d.prop("checked",!1);var f=b.serialize();i(k,f)}),m.on("click","tr[data-type='ajaxPage'] a",function(){var a=c(this),b=a.closest("li"),d=b.hasClass("disabled"),e=b.hasClass("active"),f=a.closest("form"),g=c(".js_page_goods",f),h=c(".js_page",f),j=a.data("pageNum");if(!d&&!e){h.val(j),c("tr[data-type='ajaxPage'] li.active").removeClass("active"),b.addClass("active"),g.prop("checked",!1);var l=f.serialize();i(k,l)}})},c(document).on("click",".js_remove_tr",function(a){a.stopPropagation();var b=c(this),e=b.data("confirm"),g=(b.data("ajax"),b.data("holder")||"暂无菜品"),h=b.data("path");e="undefined"==typeof e?!0:e;var i=function(){var a={};a.id=b.data("cid"),a.pid=b.data("pid"),h?c.post(h,a).done(function(a){f.issucceed(a)?(f.msg.suc(a.message||f.lang.removeSuccess,a.url),b.parent().parent("tr").fadeOut("fast",function(){c(this).closest("table.table-bordered").find("tbody tr").length<=1&&c(this).closest("table.table-bordered").prev("p.font-text").removeClass("hide"),c(this).remove()})):f.msg.error(a.message||f.lang.removeError,a.url)}).fail(function(){f.msg.info(f.lang.exception,d.url)}):b.closest("tr").fadeOut("fast",function(){var a=c(this).closest("table").find("tbody");c("tr.js_dishes_data",a).length<=1&&a.html('<tr><td colspan="3" class="text-center">'+g+"</td></tr>"),c(this).remove()})};e&&f.msg.msgbox.confirm(b.data("msg")||f.lang.confirmRemove,function(a){a&&i()}),!e&&i()})}),define("dist/commodity/template/page.html",[],'{{if count>0}}\n<tr data-type="ajaxPage">>\n<td colspan="3">\n  <div class="row text-center-xs m-t-n-sm">\n      <div class="col-md-5 hidden-sm">\n        <div class="text-muted" style="margin-top:8px">\n          {{if count>0}} \n          <label class="checkbox-inline">\n            总共{{count}}条 当前为第{{currentPage}}页\n          </label>\n          {{/if}}\n        </div>\n      </div>\n      {{if count>0}}\n      <div class="col-md-7 col-sm-12 text-right text-center-xs">\n\n          <ul class="pagination pagination-sm m-t-sm m-b-none pull-right" data-apages-total="{{totalPage}}" data-apage-current="{{currentPage}}">\n\n            <li {{if currentPage==1}} class="disabled"{{/if}}>\n              <a href="javascript:;" rel="first" data-page-num="1"><i class="fa fa-angle-double-left" title="第一页"></i></a>\n            </li>\n            <li {{if currentPage==1}} class="disabled"{{/if}}>\n              <a href="javascript:;" rel="prev" data-page-num="{{currentPage-1}}"><i class="fa fa-angle-left" title="上一页"></i></a>\n            </li>\n            {{each pagelist as item}}\n              <li {{if currentPage==item}} class="active"{{/if}}>\n                <a href="javascript:;" data-page-num="{{item}}" data-page-isnum="true">{{item}}</a>\n              </li>\n            {{/each}}\n            <li {{if currentPage==totalPage}} class="disabled"{{/if}}><a href="javascript:;" rel="next" data-page-num="{{currentPage+1}}"><i class="fa fa-angle-right" title="下一页"></i></a></li>\n            <li {{if currentPage==totalPage}} class="disabled"{{/if}}><a href="javascript:;" rel="last" data-page-num="{{totalPage}}"><i class="fa fa-angle-double-right" title="最后页" ></i></a></li>\n          </ul>\n      </div>\n      {{/if}}\n  </div>\n  </td>\n  </tr>\n  {{/if}}'),define("dist/commodity/template/template.html",[],'{{if count>0}}\n  {{each data as item}}\n    <tr data-id="{{item.id}}" class="{{if item.checked}}selected{{/if}}  {{if item.status==0}}disabled{{/if}} js_dishes_data" data-img="{{item.img}}" data-names="{{item.name}}" data-price="{{item.price}}">\n      <td>\n        {{if item.checked}}\n        <input type="checkbox" class="js_dishes_checkbox {{if item.checked}}selected{{/if}}" data-img="{{item.img}}" checked="checked"  value="{{item.id}}" data-id="{{item.id}}" data-img="{{item.img}}" data-names="{{item.name}}" data-price="{{item.price}}"/>\n        {{else}}\n        <input type="checkbox" class="js_dishes_checkbox" data-img="{{item.img}}"  value="{{item.id}}" data-id="{{item.id}}" data-img="{{item.img}}" data-names="{{item.name}}" data-price="{{item.price}}"/>\n        {{/if}}\n      </td>\n      <td>\n        <span class="pull-left thumb-sm m-r-xs">\n          <img style="height:36px" src="{{item.img}}" alt="[菜品图片]"></span>\n        <div class="media-body">\n          <div class="m-t-xs">{{item.name}}</div>\n        </div>\n      </td>\n      <td>￥{{item.price}}</td>\n    </tr>\n  {{/each}}\n{{else}}\n  <tr>\n    <td colspan="3" class="text-center">暂无数据</td>\n  </tr>\n{{/if}}'),define("dist/commodity/template/page_stores.html",[],'{{if count>0}}\n<tr data-type="ajaxPage">>\n<td colspan="4">\n  <div class="row text-center-xs m-t-n-sm">\n      <div class="col-md-5 hidden-sm">\n        <div class="text-muted" style="margin-top:8px">\n          {{if count>0}} \n          <label class="checkbox-inline">\n            总共{{count}}条 当前为第{{currentPage}}页\n          </label>\n          {{/if}}\n        </div>\n      </div>\n      {{if count>0}}\n      <div class="col-md-7 col-sm-12 text-right text-center-xs">\n\n          <ul class="pagination pagination-sm m-t-sm m-b-none pull-right" data-apages-total="{{totalPage}}" data-apage-current="{{currentPage}}">\n\n            <li {{if currentPage==1}} class="disabled"{{/if}}>\n              <a href="javascript:;" rel="first" data-page-num="1"><i class="fa fa-angle-double-left" title="第一页"></i></a>\n            </li>\n            <li {{if currentPage==1}} class="disabled"{{/if}}>\n              <a href="javascript:;" rel="prev" data-page-num="{{currentPage-1}}"><i class="fa fa-angle-left" title="上一页"></i></a>\n            </li>\n            {{each pagelist as item}}\n              <li {{if currentPage==item}} class="active"{{/if}}>\n                <a href="javascript:;" data-page-num="{{item}}" data-page-isnum="true">{{item}}</a>\n              </li>\n            {{/each}}\n            <li {{if currentPage==totalPage}} class="disabled"{{/if}}><a href="javascript:;" rel="next" data-page-num="{{currentPage+1}}"><i class="fa fa-angle-right" title="下一页"></i></a></li>\n            <li {{if currentPage==totalPage}} class="disabled"{{/if}}><a href="javascript:;" rel="last" data-page-num="{{totalPage}}"><i class="fa fa-angle-double-right" title="最后页" ></i></a></li>\n          </ul>\n      </div>\n      {{/if}}\n  </div>\n  </td>\n  </tr>\n  {{/if}}'),define("dist/commodity/template/stores.html",[],'{{if count>0}}\n  {{each data as item}}\n    <tr data-id="{{item.id}}" class="{{if item.checked}}selected{{/if}}  {{if item.status==0}}disabled{{/if}} js_dishes_data" data-address="{{item.address}}" data-names="{{item.name}}" data-phone="{{item.phone}}">\n      {{if item.id}}\n      <td>\n        {{if item.checked}}\n        <input type="radio" name="stores" class="js_dishes_radio {{if item.checked}}selected{{/if}}" data-img="{{item.img}}" checked="checked"  value="{{item.id}}" data-id="{{item.id}}" data-address="{{item.address}}" data-names="{{item.name}}"  data-phone="{{item.phone}}"/>\n        {{else}}\n        <input type="radio" name="stores" class="js_dishes_radio" data-img="{{item.img}}"  value="{{item.id}}" data-id="{{item.id}}" data-address="{{item.address}}" data-names="{{item.name}}" data-phone="{{item.phone}}"/>\n        {{/if}}\n      </td>\n      {{/if}}\n      <td>\n        {{item.name}}\n      </td>\n      <td>{{item.address}}</td>\n      <td>{{item.phone}}</td>\n    </tr>\n  {{/each}}\n{{else}}\n  <tr>\n    <td colspan="4" class="text-center">暂无数据</td>\n  </tr>\n{{/if}}'),define("dist/commodity/template/msg.html",[],'{{if count>0}}\n  {{each data as item}}\n    <tr>\n      <td>\n        {{item.id}}\n      </td>\n      <td>{{item.openId}}</td>\n      <td>{{item.msg}}</td>\n    </tr>\n  {{/each}}\n{{else}}\n  <tr>\n    <td colspan="4" class="text-center">暂无数据</td>\n  </tr>\n{{/if}}'),define("dist/commodity/template/goods.html",[],'{{if count>0}}\n  {{each data as item}}\n    <tr data-id="{{item.id}}" class="{{if item.checked}}selected{{/if}}  {{if item.status==0}}disabled{{/if}} js_dishes_data" data-img="{{item.img}}" data-names="{{item.name}}" data-price="{{item.price}}">\n      {{if item.id}}\n      <td>\n        {{if item.checked}}\n        <input type="radio" name="stores" class="js_dishes_radio {{if item.checked}}selected{{/if}}" data-img="{{item.img}}" checked="checked"  value="{{item.id}}" data-id="{{item.id}}" data-names="{{item.name}}" data-price="{{item.price}}"/>\n        {{else}}\n        <input type="radio" name="stores" class="js_dishes_radio" data-img="{{item.img}}"  value="{{item.id}}" data-id="{{item.id}}" data-names="{{item.name}}" data-price="{{item.price}}"/>\n        {{/if}}\n      </td>\n      {{/if}}\n      <td>\n        <span class="pull-left thumb-sm m-r-xs">\n          <img style="height:36px;" src="{{item.img}}" alt="{{item.name}}"></span>\n        <div class="media-body">\n          <div class="m-t-xs">{{item.name}}</div>\n        </div>\n      </td>\n      <td>{{item.price}}</td>\n    </tr>\n  {{/each}}\n{{else}}\n  <tr>\n    <td colspan="3" class="text-center">暂无数据</td>\n  </tr>\n{{/if}}');