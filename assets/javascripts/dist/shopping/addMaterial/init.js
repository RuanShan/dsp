/*! weimob_vshop_admin
*author:<a.b.c@hd3p.com> */
define("dist/shopping/addMaterial/init",["$","dist/application/app","./select"],function(a){"use strict";function b(){var a=e(".cover_appmsg_item");e.each(a,function(b,c){var d=e(c).find(".js_del"),f=e(c).find(".js_edit"),g=e(c).find(".js_move_up"),h=e(c).find(".js_move_down");0==b?(g.addClass("hide"),d.addClass("hide"),1==a.length?(h.addClass("hide"),f.addClass("hide")):(h.removeClass("hide"),f.removeClass("hide"))):b==a.length-1?(d.removeClass("hide"),f.removeClass("hide"),g.removeClass("hide"),h.addClass("hide")):(d.removeClass("hide"),f.removeClass("hide"),g.removeClass("hide"),h.removeClass("hide")),d.data("size",b),f.data("size",b),g.data("size",b),h.data("size",b)})}function c(){var a=e(".prize-list").not(".hide").find(".js_message");e.each(a,function(a,b){var c=e(b).find("[data-find-name]");e.each(c,function(b,c){var d=e(c).attr("name");d=d.replace(/(\[messages\]\[\d{1,6}\])/,"[messages]["+a+"]"),e(c).attr("name",d)})})}function d(){var b=e('[data-toggle="kindeditor"]');b.length>0&&a.async("kindeditor",function(){b.each(function(){var a=e(this),b=a.data("config"),c=a.data("tongji"),d=b?g.kindeditor[b]:g.kindeditor["default"];if(window.extraUploadPath&&(d=e.extend({},d,{uploadJson:window.extraUploadPath})),c){var f=a.data("tongjiTarget"),h=a.data("ruleRangelength")[1];if(f){var i=e(f),j=i.html();d=e.extend({},d,{afterChange:function(){var a="remain"==c?h-this.count():this.count();0>a||a>h?i.addClass("error"):i.removeClass("error"),i.html(j.format(a))}})}}KindEditor.create(a,d)})})}{var e=a("$"),f=a("dist/application/app"),g=f.config;f.method}if(a("./select"),window.graphic_set){var h={};h.data=[],e(template("js_rules_temp",window.graphic_set)).insertBefore("a.add_prize"),e("#parent_box").append(template("js_list_temp",window.graphic_set)),e('[data-toggle="popover"]').popoverClosable()}e(function(){b()});var i=function(a,b){this.obj=a,this.opts=e.extend(!0,{index:2,business:!0,callback:e.noop},b||{}),this.init()};i.prototype={init:function(){this.action()},action:function(){var a=this;e(document).on("click",a.obj,function(){var c=e(this).data("temp"),d=e(this).data("parentid"),f=e(d).find(".prize-list").length,h=e(this).data("max");if(f>=h)return void g.msg.info("最多添加{0}个".format(h)||"超过添加限制");var i={};i.num=f,i.size=a.opts.index++,window.graphic_add.data[0].index=f,e(template("js_rules_temp",window.graphic_add)).insertAfter(e(this).prev("div.cover_appmsg_item")),e(d).append(template(c,window.graphic_add)),a.opts.business&&a.opts.callback(i.num),b()}),e(document).on("click","a.js_del",function(){var c=e(this).data("array"),d=e(this).data("size");e(this).closest("div.js_appmsg_item").remove(),e("#list"+d).find('[data-find-name="msgtextcontent"]').removeAttr("data-rule-required"),e("#list"+d).remove(),e("div.cover_appmsg_item").removeClass("on"),e("div.cover_appmsg_item:last").addClass("on"),e("div.prize-list").addClass("hide"),e("div.prize-list:last").removeClass("hide");var f=e(".add_prize").position().top-130;e("#parent_box").css("margin-top",f);{var g=e(this).data("parentid");e(g).find(".prize-list").length,e(g).find(a.obj).data("max")}a.prizeSet(g,c),a.scrollT(f),KindEditor.instances.splice(d,1),b()}),e(document).on("click","a.js_move_down",function(){var c=e(this),f=c.data("parentid"),g=c.data("array"),h=c.closest(".cover_appmsg_item"),i=c.closest("div.cover_appmsg_item").next().position().top,j=h.next(),k=h.index(),l=e("#list"+k),m=l.next();KindEditor.remove('[data-toggle="kindeditor"]'),e("[data-find-name]",l).each(function(){var a=e(this).attr("name");a=a.replace(/(articles\[\d{1,6}\])/,"articles[999999]"),e(this).attr("name",a)}),j.after(h),m.after(l),b(),e(".cover_appmsg_item").addClass("js_appmsg_item").removeAttr("style"),e(".cover_appmsg_item:first").removeClass("js_appmsg_item").attr("style","border:0;");var n,o=e(this).data("size"),p="#list"+o;n=i-34>0?i-34:0,0==o&&(n=0),e("div.cover_appmsg_item").removeClass("on"),e(this).closest("div.cover_appmsg_item").addClass("on"),a.prizeSet(f,g),a.showBoxFn(p,n),a.scrollT(n),d()}),e(document).on("click","a.js_move_up",function(){var c=e(this),f=c.data("parentid"),g=c.data("array"),h=c.closest(".cover_appmsg_item"),i=c.closest("div.cover_appmsg_item").prev().position().top,j=h.prev(),k=h.index(),l=e("#list"+k),m=l.prev();KindEditor.remove('[data-toggle="kindeditor"]'),e("[data-find-name]",m).each(function(){var a=e(this).attr("name");a=a.replace(/(articles\[\d{1,6}\])/,"articles[999999]"),e(this).attr("name",a)}),j.before(h),m.before(l),b(),e(".cover_appmsg_item").addClass("js_appmsg_item").removeAttr("style"),e(".cover_appmsg_item:first").removeClass("js_appmsg_item").attr("style","border:0;");var n,o=e(this).data("size"),p="#list"+o;n=i-34>0?i-34:0,0==o&&(n=0),e("div.cover_appmsg_item").removeClass("on"),e(this).closest("div.cover_appmsg_item").addClass("on"),a.prizeSet(f,g),a.showBoxFn(p,n),a.scrollT(n),d()}),e(document).on("click","a.js_edit",function(){var b=e(this).closest("div.cover_appmsg_item").position().top;if(!e(this).closest("div.cover_appmsg_item").hasClass("on")){var c,d=e(this).data("size"),f="#list"+d;c=b-34>0?b-34:0,0==d&&(c=0),e("div.cover_appmsg_item").removeClass("on"),e(this).closest("div.cover_appmsg_item").addClass("on"),a.showBoxFn(f,c),a.scrollT(c)}}),e(document).on("keyup","input.title-change",function(){var a=e(this).val();e("div.cover_appmsg_item").each(function(){e(this).hasClass("on")&&e(this).find("h4.appmsg_title a").html(a)})}),e(document).on("keyup","input.title-subhead",function(){var a=e(this).val();e("div.cover_appmsg_item").each(function(){e(this).hasClass("on")&&e(this).find("h4.appmsg_title a").html(a)})}),e(document).on("callback",".js_selectimg",function(a,b){var c=b;e("div.cover_appmsg_item").each(function(){e(this).hasClass("on")&&e(this).find("img.js_appmsg_thumb").attr("src",c)})}),e(document).on("click",".js_change_coverimg",function(){var a=e(this),b=a.parent().find("img"),c=b.attr("src"),d=a.closest(".prize-list").find(".js_coverimg");e("div.cover_appmsg_item").each(function(){e(this).hasClass("on")&&e(this).find("img.js_appmsg_thumb").attr("src",c)}),d.find("img").attr("src",c),d.find("input").val(c)}),e(document).on("click","span.js_common_link",function(){var a=e(this).closest("div.prize-list").find('[data-toggle="city_custom"]');a.hasClass("hide")&&a.removeClass("hide"),e(this).closest("div.form-group").addClass("hide")}),e(document).on("change","select.js_cxselect",function(){var a=e(this).find("option:selected").val();1==a&&(e(this).closest("div.form-group").addClass("hide"),e(this).closest("div.prize-list").find("div.common_link").removeClass("hide"))}),e('[data-toggle="city_custom"]').each(function(){e(this).cxSelect({selects:["first","second"],nodata:"none",url:window.cxSelectAdd})})},prizeSet:function(){e("#parent_box .prize-list").each(function(a){var b="list"+a;e(this).attr("id",b);var c=e(this).find("[data-find-name]");e.each(c,function(b,c){var d=e(c).attr("name");d=d.replace(/(articles\[\d{1,6}\])/,"articles["+a+"]"),e(c).attr("name",d)})})},showBoxFn:function(a,b){e("#parent_box div.prize-list").addClass("hide"),e(a).removeClass("hide"),e("#parent_box").css("margin-top",b)},scrollT:function(a){e(".scrollable").animate({scrollTop:a},300)}},new i(".add_prize",{callback:function(b){var c=e(".add_prize").position().top-128;e("#parent_box div.prize-list").addClass("hide"),e("#list"+b).removeClass("hide"),e("#parent_box").css("margin-top",c),e("div.cover_appmsg_item").removeClass("on"),e("div.cover_appmsg_item:last").addClass("on"),e(".scrollable").animate({scrollTop:c},300);var d=e('[data-toggle="kindeditor"]',e("#list"+b)),f=e('[data-toggle="city_custom"]',e("#list"+b));d.length>0&&a.async("kindeditor",function(){d.each(function(){var a=e(this),b=a.data("config"),c=a.data("tongji"),d=b?g.kindeditor[b]:g.kindeditor["default"];if(window.extraUploadPath&&(d=e.extend({},d,{uploadJson:window.extraUploadPath})),c){var f=a.data("tongjiTarget"),h=a.data("ruleRangelength")[1];if(f){var i=e(f),j=i.html();d=e.extend({},d,{afterChange:function(){var a="remain"==c?h-this.count():this.count();0>a||a>h?i.addClass("error"):i.removeClass("error"),i.html(j.format(a))}})}}KindEditor.create(a,d)})}),e('[data-toggle="popover"]').popoverClosable(),f.length>0&&f.cxSelect({selects:["first","second"],nodata:"none",url:window.cxSelectAdd})}}),e(window).bind("beforeunload",function(){return"您编辑的内容尚未保存，离开后将失去所编辑内容，确定离开吗？"}),e("#bsubmit").on("click",function(){e(window).unbind("beforeunload"),e("div.prize-list").each(function(){if(""==e(this).find('[data-find-name="title"]').val())return j(e(this).find('[data-find-name="title"]')),!1;if(0==e(this).find(".js_msg_type:checked").val())e.each(e(this).find('[data-find-name="msgtextcontent"]'),function(a,b){return""==e(b).val()?(j(e(this)),!1):void 0});else if(e(this).find(".js_good_container").hasClass("hide"))return g.msg.error("请选择商品"),j(e(this).find('[data-find-name="msgcontent"]')),!1})});var j=function(a){var b,c=e(a).closest("div.prize-list").attr("id"),d=c.charAt(c.length-1);e("div#parent_box div.prize-list").addClass("hide"),e("#"+c).removeClass("hide"),e("div.cover_appmsg_item").each(function(){e(this).find("a.js_edit").data("size")==d?(e(this).addClass("on"),b=e(this).position().top-32,0==d&&(b=0),e("#parent_box").css("margin-top",b),e(".scrollable").animate({scrollTop:b},300)):e(this).removeClass("on")})};e(document).on("click",".js_msg_type",function(){var a=e(this),b=a.closest(".prize-list"),c=a.data("msgtype"),f=e(".js_msgtype0",b),g=e(".js_msgtype1",b),h=e(".js_msgtype"+c,b),i=e(".js_msgtype",b);i.addClass("hide"),h.removeClass("hide"),KindEditor.remove('[data-toggle="kindeditor"]'),0==c?(e.each(f.find("input, textarea"),function(a,b){e(b).removeAttr("disabled"),"msgtextcontent"==e(b).attr("data-find-name")&&e(b).attr("data-toggle","kindeditor")}),e.each(g.find("input, textarea"),function(a,b){e(b).attr("disabled","disabled")})):1==c&&(e.each(g.find("input, textarea"),function(a,b){e(b).removeAttr("disabled")}),e.each(f.find("input, textarea"),function(a,b){e(b).attr("disabled","disabled"),"msgtextcontent"==e(b).attr("data-find-name")&&""==e(b).val()&&e(b).removeAttr("data-toggle")})),d()}),e(document).on("click",".js_del_message",function(){var a=e(this),b=a.closest(".form-group"),d=b.next();b.remove(),d.remove(),c()}),e(document).on("click",".js_insert_texteditor",function(){var a=e(this),b=a.closest(".form-group"),f=e(".cover_appmsg_item.on").index(),g={itemIndex:f,messageIndex:e("#list"+f).find(".js_message").length},h=template("js_insert_texteditor_temp",g);b.after(h),c(),d()}),e(document).on("click","[data-toggle='commodity']",function(b){var c=e(this);a.async("dist/commodity/init",function(a){a.init(document,c,b)})})}),define("dist/shopping/addMaterial/select",[],function(){!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(a){a.cxSelect=function(b){for(var c,b,d={dom:{},api:{}},e=function(a){return a&&("function"==typeof HTMLElement||"object"==typeof HTMLElement)&&a instanceof HTMLElement?!0:a&&a.nodeType&&1===a.nodeType?!0:!1},f=function(a){return a&&a.length&&("function"==typeof jQuery||"object"==typeof jQuery)&&a instanceof jQuery?!0:!1},g=function(a){return Array.isArray?Array.isArray(a):"[object Array]"===Object.prototype.toString.call(a)},h=0,i=arguments.length;i>h;h++)f(arguments[h])?c=arguments[h]:e(arguments[h])?c=a(arguments[h]):"object"==typeof arguments[h]&&(b=arguments[h]);return c.length<1?void 0:(d.init=function(){var d=this;if(d.dom.box=c,d.settings=a.extend({},a.cxSelect.defaults,b,{url:d.dom.box.data("url"),nodata:d.dom.box.data("nodata"),required:d.dom.box.data("required"),firstTitle:d.dom.box.data("firstTitle"),firstValue:d.dom.box.data("firstValue")}),d.settings.selects.length){d.selectArray=[],d.selectSum=d.settings.selects.length;for(var e=0;e<d.selectSum&&d.dom.box.find("select."+d.settings.selects[e]);e++)d.selectArray.push(d.dom.box.find("select."+d.settings.selects[e]));d.selectSum=d.selectArray.length,d.selectSum&&("string"==typeof d.settings.url?a.getJSON(d.settings.url,function(a){d.dataJson=a,d.buildContent()}):"object"==typeof d.settings.url&&(d.dataJson=d.settings.url,d.buildContent()))}},d.getIndex=function(a){return this.settings.required?a:a-1},d.getNewOptions=function(b,c){if(b){var d=this.settings.firstTitle,e=this.settings.firstValue,f=b.data("firstTitle"),g=b.data("firstValue"),h="";return("string"==typeof f||"number"==typeof f||"boolean"==typeof f)&&(d=f.toString()),("string"==typeof g||"number"==typeof g||"boolean"==typeof g)&&(e=g.toString()),this.settings.required||(h='<option value="'+e+'">'+d+"</option>"),a.each(c,function(a,b){h+="string"==typeof b.v||"number"==typeof b.v||"boolean"==typeof b.v?'<option value="'+b.v+'">'+b.n+"</option>":'<option value="'+b.n+'">'+b.n+"</option>"}),h}},d.buildContent=function(){var a=this;a.dom.box.on("change","select",function(){a.selectChange(this.className)});var b=a.getNewOptions(a.selectArray[0],a.dataJson);a.selectArray[0].html(b).prop("disabled",!1).trigger("change"),a.setDefaultValue()},d.setDefaultValue=function(a){a=a||0;var b,c=this;a>=c.selectSum||!c.selectArray[a]||(b=c.selectArray[a].data("value"),("string"==typeof b||"number"==typeof b||"boolean"==typeof b)&&(b=b.toString(),setTimeout(function(){c.selectArray[a].val(b).trigger("change"),a++,c.setDefaultValue(a)},1)))},d.selectChange=function(a){a=a.replace(/ /g,","),a=","+a+",";for(var b,c,d,e,f=[],h=0;h<this.selectSum;h++)f.push(this.getIndex(this.selectArray[h].get(0).selectedIndex)),"number"==typeof b&&h>b&&(this.selectArray[h].empty().prop("disabled",!0),"none"===this.settings.nodata?this.selectArray[h].css("display","none"):"hidden"===this.settings.nodata&&this.selectArray[h].css("visibility","hidden")),a.indexOf(","+this.settings.selects[h]+",")>-1&&(b=h);c=b+1,d=this.dataJson;for(var h=0;c>h;h++){if("undefined"==typeof d[f[h]]||g(d[f[h]].s)===!1||!d[f[h]].s.length)return;d=d[f[h]].s}this.selectArray[c]&&(e=this.getNewOptions(this.selectArray[c],d),this.selectArray[c].html(e).prop("disabled",!1).css({display:"",visibility:""}).trigger("change"))},d.init(),this)},a.cxSelect.defaults={selects:[],url:null,nodata:null,required:!1,firstTitle:"请选择",firstValue:""},a.fn.cxSelect=function(b,c){return this.each(function(){a.cxSelect(this,b,c)}),this}})});