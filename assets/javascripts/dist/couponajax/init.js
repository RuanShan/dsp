/*! weimob_vshop_admin
*author:<a.b.c@hd3p.com> */
define("dist/couponajax/init",["$","dist/application/app","./template/modal.html","./template/goods.html","./template/givepacket.html","./template/packet.html","./template/coupon.html"],function(require,exports,module){"use strict";var $=require("$"),app=require("dist/application/app"),config=app.config,method=app.method,modals=require("./template/modal.html"),goods_temp=require("./template/goods.html"),givepacket=require("./template/givepacket.html"),packet=require("./template/packet.html"),coupon=require("./template/coupon.html"),activity_selectid=[];template.helper("activity_selected",function(a,b){var c="";return $.each(b,function(){for(var b in this)b&&b==a&&(c="checked='checked'")}),c}),exports.init=function(el,button){function init(a,b,c,d,e){if(e.list.length){var f=e.list[e.list.length-1];b=b+"&id="+f.id+"&value="+f.value}else b+="&id=&value=";method.post(a,function(a){if(config.issucceed(a)){switch(Array.prototype.push.apply(activity_selectid,e.arr),activity_selectid=unique(activity_selectid),a.types=d,a.selectid=activity_selectid,a.data.pagelist=pageDate(a.data),d){case"goods":c.html(template.compile(goods_temp)(a));break;case"packet":c.html(template.compile(packet)(a));break;case"givepacket":c.html(template.compile(givepacket)(a));break;case"coupon":c.html(template.compile(coupon)(a))}allcheck()}else config.msg.error(a.message)},config.lang.exception,!1,b)}function pageDate(a){var b=[],c=a.totalPage,d=a.currentPage;if(c>0)if(c-d>=2){var e=1,f=5;e=d-2>0?d-2:1,f=e+4;for(var g=e;f>=g;g++)g>0&&c>=g&&b.push(g)}else{var e=1,f=5;f=c>=d+2?d+2:c,e=f-4;for(var g=e;f>=g;g++)g>0&&c>=g&&b.push(g)}return b}function selectid(a){var b=(a.closest(a.data("target")),[]),c=[],d=a.closest(a.data("ptarget")),e=a.val(),f=a.next(".js_coupon_id").val(),g=a.prev(".js_coupon_value").val();e&&b.push(getjson(f,e,g));var h=$(a.data("target"),d).length,i=$(".js_con_box "+a.data("target"),d).length,j=h-i,k=a.index();return a.closest(".js_con_box").length&&(k=j+k),$(a.data("target"),d).each(function(a){if(k>=a){var b=$(this),d=$('[data-toggle="couponajax"]',b),e=d.val(),f=d.next(".js_coupon_id").val(),g=d.prev(".js_coupon_value").val();e&&c.push({id:f,name:e,value:g})}}),{arr:b,list:c}}function getjson(key,value,source){var b=eval('({"'+key+'": "'+value+"|^@^|"+source+'"})');return b}function setDate(a){var b=$(a),c=b.prop("checked"),d=b.val(),e=b.data("names"),f=b.data("source"),g=b.closest("table");c?("radio"==b.attr("type")?activity_selectid=[getjson(d,e,f)]:activity_selectid.push(getjson(d,e,f)),allcheck()):(g.find("th input").prop("checked",!1),$.each(activity_selectid,function(a){for(var b in this)b&&b==d&&activity_selectid.splice(a,1)}))}function unique(a){for(var b=[],c={},d=0,e=a.length;e>d;d++)for(var f in a[d])f&&(c[f]||(b.push(a[d]),c[f]=!0));return b}function allcheck(){var a=$("#js_allActivity table"),b=$("input",a),c=b.length,d=0;b.each(function(){$(this).prop("checked")&&d++}),d==c-1&&$("th input",a).prop("checked",!0)}$("#ajaxModalLink").remove(),activity_selectid=[];var $modal=$('<div class="modal fade" id="ajaxModalLink"><div class="modal-body "></div></div>');$(document).append($modal),$modal.modal();var path=button.data("path"),types=button.data("type"),opera=button.data("opera"),title=button.data("title")||"选择活动",search=button.data("search")||!1,update=button.data("update"),subtitle=button.data("subtitle")||"",tempid=button.data("tempid"),targets=button.data("target"),name="活动";switch(types){case"coupon":name="活动";break;case"packet":name="活动";break;case"postage":name="活动";break;case"givepacket":name="活动"}var data={path:path,types:types,opera:opera,name:name,search:search,title:title,subtitle:subtitle};$modal.append2(template.compile(modals)(data),function(){var a=$("#js_allActivity",$modal),b=$(".search-form",$modal),c=b.serialize();init(path,c,a,types,selectid(button))}),$modal.on("click",".js_allactivity_select",function(){var a=($(this),[]),b={};$.each(activity_selectid,function(){for(var b in this)b&&a.push({id:b,name:this[b].split("|^@^|")[0],source:this[b].split("|^@^|")[1]})}),b.result=a,a.length?(button.val(a[0].name),button.next(".js_coupon_id").val(a[0].id),button.prev(".js_coupon_value").val(a[0].source),$modal.modal("hide"),button.removeClass("error"),$("span.error",button.closest(".form-group")).remove()):config.msg.error("请"+title)}),$modal.on("click","table td input",function(){setDate(this)}),$modal.on("click","table th input",function(){var a=$(this),b=a.prop("checked"),c=a.closest("table"),d=c.find("td input");b?d.prop("checked",!0):d.prop("checked",!1),d.each(function(){setDate(this)}),activity_selectid=unique(activity_selectid)}),$modal.on("click","footer[data-type='ajaxPage'] a",function(){var a=$(this),b=a.closest("li"),c=b.hasClass("disabled"),d=b.hasClass("active"),e=a.closest("div.modal-body"),f=e.find("form"),g=(f.data("type"),f.data("path")),h=$(".js_alllink_page",f),i=e.find("#js_allActivity"),j=a.data("pageNum");if(g+="&submittype=page",!c&&!d){h.val(j),$modal.find("footer[data-type='ajaxPage'] li.active").removeClass("active"),b.addClass("active");var k=f.serialize();i.length>0&&init(g,k,i,types,selectid(button))}}),$modal.on("click","button[data-type='ajaxSearch']",function(){var a=$(this),b=a.closest("div.modal-body"),c=a.closest("form"),d=c.data("path"),e=$(".js_alllink_page",c),f=b.find("#js_allActivity");e.val(1);var g=c.serialize();d+="&submittype=search",f.length>0&&init(d,g,f,types,selectid(button))})}}),define("dist/couponajax/template/modal.html",[],'<div class="modal-dialog" style="width:800px">\n    <div class="modal-content">\n        <div class="modal-header">\n            <button type="button" class="close" data-dismiss="modal">×</button>\n            <h4 class="modal-title">{{title}}<small class="m-l-sm">{{subtitle}}</small></h4>\n        </div>\n        <div class="modal-body">\n            <form class="form-horizontal search-form {{if !search}} hide{{/if}}" data-type="goods" data-path="{{path}}">\n                <div class="form-group">\n                    <div class="col-sm-6 col-sm-offset-6">\n                        <div class="input-group">\n                            <input type="text" class="input-sm form-control" name="keywords" placeholder="请输入{{name}}名称" value=""/>\n                            <span class="input-group-btn">\n                                <button class="btn btn-sm btn-default" data-type="ajaxSearch" type="button" title="搜索"> <i class="fa fa-search"></i>\n                                </button>\n                            </span>\n                        </div>\n                    </div>\n                </div>\n                <input type="hidden" name="page" class="js_alllink_page" value="1"/>\n            </form>\n            <section class="panel panel-default" style="margin-bottom:0;">\n                <div id="js_allActivity">\n                   \n                </div>\n\n            </section>\n\n        </div>\n        <form class="form-horizontal form-modal" method="post"  novalidate="novalidate">\n            <div class="modal-footer">\n                <input type="hidden" value="" name="id" id="js_act_selectids">\n                {{if opera!="look"}}\n                <button type="button" class="btn btn-primary js_allactivity_select">确定</button>\n                {{/if}}\n                <button type="button" class="btn btn-default" data-dismiss="modal">{{if opera==\'look\'}}关闭{{else}}取消{{/if}}</button>\n            </div>\n        </form>\n    </div>\n</div>'),define("dist/couponajax/template/goods.html",[],' {{if data.count>0}}\n  <div style="padding:10px">已选择<span class="error">{{data.count}}</span>个宝贝</div>\n{{/if}}\n <div class="table-responsive {{if data.count>0}}b-t{{/if}}">\n\n<table class="table table-striped m-b-none">\n  <thead>\n    <tr>\n      <th>活动名称</th>\n      <th style="width:200px">当前价格（￥）</th>\n    </tr>\n  </thead>\n  <tbody>\n    {{if data.items}}\n      {{each data.items as zitem}}\n      <tr>\n       \n        <td class="v-middle">\n          <div class="media">\n            <span class="pull-left thumb-sm" style="width:45px;height:45px;">\n              <img src="{{zitem.img}}" style="width:45px;height:45px;" alt="John said"></span>\n            <div class="media-body">\n              <div>\n                <a href="#">{{zitem.name}}</a>\n              </div>\n            </div>\n          </div>\n          <input type="checkbox" class="hide" value="{{zitem.id}}" data-names="{{zitem.name}}" >\n        </td>\n        <td  class="v-middle text-danger">{{zitem.price}}</td>\n      </tr>\n      {{/each}}\n{{else}}\n    <tr>\n      <td colspan="2" class="nodata text-center">暂无数据</td>\n    </tr>\n    {{/if}}\n  </tbody>\n</table>\n{{if data.count>0}}\n<footer class="footer bg-white b-t m-t-sm" data-type="ajaxPage">\n  <div class="row text-center-xs">\n    <div class="col-md-6 hidden-sm">\n      <p class="text-muted m-t">总共{{data.count}}条 当前为第{{data.currentPage}}页</p>\n    </div>\n    <div class="col-md-6 col-sm-12 text-right text-center-xs">\n      <ul class="pagination pagination-sm m-t-sm m-b-none" data-apages-total="{{data.totalPage}}" data-apage-current="{{data.currentPage}}">\n\n        <li {{if data.currentPage==1}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="first" data-page-num="1"> <i class="fa fa-angle-double-left" title="第一页"></i>\n          </a>\n        </li>\n        <li {{if data.currentPage==1}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="prev" data-page-num="{{data.currentPage-1}}"> <i class="fa fa-angle-left" title="上一页"></i>\n          </a>\n        </li>\n        {{each data.pagelist as item}}\n        <li {{if data.currentPage==item}} class="active"{{/if}}>\n          <a href="javascript:;" data-page-num="{{item}}" data-page-isnum="true">{{item}}</a>\n        </li>\n        {{/each}}\n        <li {{if data.currentPage==data.totalPage}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="next" data-page-num="{{data.currentPage+1}}">\n            <i class="fa fa-angle-right" title="下一页"></i>\n          </a>\n        </li>\n        <li {{if data.currentPage==data.totalPage}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="last" data-page-num="{{data.totalPage}}">\n            <i class="fa fa-angle-double-right" title="最后页" ></i>\n          </a>\n        </li>\n      </ul>\n    </div>\n  </div>\n</footer>\n{{/if}}\n</div>'),define("dist/couponajax/template/givepacket.html",[],'<table class="table table-striped m-b-none">\n  <thead>\n    <tr>\n      <th class="with-checkbox">\n      </th>\n      <th style="width:100px">活动名称</th>\n      <th>类型</th>\n      <th>预算</th>\n      <th style="width:150px">有效时间</th>\n      <th>状态</th>\n    </tr>\n  </thead>\n  <tbody>\n    {{if data.activity}}\n      {{each data.activity as zitem}}\n      <tr>\n        <td>\n          <input type="radio" name=\'activitylistid\' data-names="{{zitem.name}}" value="{{zitem.id}}" {{activity_selected zitem.id selectid}}></td>\n        <td>{{zitem.name}}</td>\n        <td>{{zitem.type}}</td>\n        <td>￥{{zitem.value}}</td>\n        <td>{{zitem.date}}</td>\n        <td>{{zitem.status}}</td>\n      </tr>\n      {{/each}}\n{{else}}\n    <tr>\n      <td colspan="6" class="nodata text-center">暂无数据</td>\n    </tr>\n    {{/if}}\n  </tbody>\n</table>\n{{if data.count>0}}\n<footer class="footer bg-white b-t m-t-sm" data-type="ajaxPage">\n  <div class="row text-center-xs">\n    <div class="col-md-6 hidden-sm">\n      <p class="text-muted m-t">总共{{data.count}}条 当前为第{{data.currentPage}}页</p>\n    </div>\n    <div class="col-md-6 col-sm-12 text-right text-center-xs">\n      <ul class="pagination pagination-sm m-t-sm m-b-none" data-apages-total="{{data.totalPage}}" data-apage-current="{{data.currentPage}}">\n\n        <li {{if data.currentPage==1}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="first" data-page-num="1"> <i class="fa fa-angle-double-left" title="第一页"></i>\n          </a>\n        </li>\n        <li {{if data.currentPage==1}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="prev" data-page-num="{{data.currentPage-1}}"> <i class="fa fa-angle-left" title="上一页"></i>\n          </a>\n        </li>\n        {{each data.pagelist as item}}\n        <li {{if data.currentPage==item}} class="active"{{/if}}>\n          <a href="javascript:;" data-page-num="{{item}}" data-page-isnum="true">{{item}}</a>\n        </li>\n        {{/each}}\n        <li {{if data.currentPage==data.totalPage}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="next" data-page-num="{{data.currentPage+1}}">\n            <i class="fa fa-angle-right" title="下一页"></i>\n          </a>\n        </li>\n        <li {{if data.currentPage==data.totalPage}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="last" data-page-num="{{data.totalPage}}">\n            <i class="fa fa-angle-double-right" title="最后页" ></i>\n          </a>\n        </li>\n      </ul>\n    </div>\n  </div>\n</footer>\n{{/if}}'),define("dist/couponajax/template/packet.html",[],'<table class="table table-striped m-b-none">\n  <thead>\n    <tr>\n      <th class="with-checkbox">\n        <input type="checkbox" />\n      </th>\n      <th style="width:100px">活动名称</th>\n      <th>类型</th>\n      <th>预算</th>\n      <th style="width:150px">有效时间</th>\n      <th>状态</th>\n    </tr>\n  </thead>\n  <tbody>\n    {{if data.activity}}\n      {{each data.activity as zitem}}\n      <tr>\n        <td>\n          <input type="checkbox" value="{{zitem.id}}" data-names="{{zitem.name}}" {{activity_selected zitem.id selectid}}></td>\n        <td>{{zitem.name}}</td>\n        <td>{{zitem.type}}</td>\n        <td>￥{{zitem.value}}</td>\n        <td>{{zitem.date}}</td>\n        <td>{{zitem.status}}</td>\n      </tr>\n      {{/each}}\n{{else}}\n    <tr>\n      <td colspan="6" class="nodata text-center">暂无数据</td>\n    </tr>\n    {{/if}}\n  </tbody>\n</table>\n{{if data.count>0}}\n<footer class="footer bg-white b-t m-t-sm" data-type="ajaxPage">\n  <div class="row text-center-xs">\n    <div class="col-md-6 hidden-sm">\n      <p class="text-muted m-t">总共{{data.count}}条 当前为第{{data.currentPage}}页</p>\n    </div>\n    <div class="col-md-6 col-sm-12 text-right text-center-xs">\n      <ul class="pagination pagination-sm m-t-sm m-b-none" data-apages-total="{{data.totalPage}}" data-apage-current="{{data.currentPage}}">\n\n        <li {{if data.currentPage==1}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="first" data-page-num="1"> <i class="fa fa-angle-double-left" title="第一页"></i>\n          </a>\n        </li>\n        <li {{if data.currentPage==1}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="prev" data-page-num="{{data.currentPage-1}}"> <i class="fa fa-angle-left" title="上一页"></i>\n          </a>\n        </li>\n        {{each data.pagelist as item}}\n        <li {{if data.currentPage==item}} class="active"{{/if}}>\n          <a href="javascript:;" data-page-num="{{item}}" data-page-isnum="true">{{item}}</a>\n        </li>\n        {{/each}}\n        <li {{if data.currentPage==data.totalPage}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="next" data-page-num="{{data.currentPage+1}}">\n            <i class="fa fa-angle-right" title="下一页"></i>\n          </a>\n        </li>\n        <li {{if data.currentPage==data.totalPage}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="last" data-page-num="{{data.totalPage}}">\n            <i class="fa fa-angle-double-right" title="最后页" ></i>\n          </a>\n        </li>\n      </ul>\n    </div>\n  </div>\n</footer>\n{{/if}}'),define("dist/couponajax/template/coupon.html",[],'<div class="table-responsive">\n<table class="table table-striped m-b-none">\n  <thead>\n    <tr>\n      <th class="with-checkbox">\n        \n      </th>\n      <th >名称</th>\n      <th style="width:160px">使用时间</th>\n      <th style="width:100px">条件</th>\n      <th style="width:60px">面值</th>\n      <th style="width:97px">剩余发行量</th>\n      <th style="width:85px">每人限发</th>\n    </tr>\n  </thead>\n  <tbody>\n    {{if data.items}}\n      {{each data.items as zitem}}\n      <tr>\n        <td>\n          <input type="radio" value="{{zitem.id}}" name=\'couponlistid\' data-names="{{zitem.name}}" data-source="{{zitem.value}}" {{activity_selected zitem.id selectid}}></td>\n        <td>{{zitem.name}}</td>\n        <td>{{zitem.date}}</td>\n        <td>{{zitem.condition}}</td>\n        <td>{{zitem.value}}元</td>\n        <td>{{zitem.circulation }}</td>\n        <td>{{zitem.limit}}</td>\n        \n      </tr>\n      {{/each}}\n{{else}}\n    <tr>\n      <td colspan="4" class="nodata text-center">暂无数据</td>\n    </tr>\n    {{/if}}\n  </tbody>\n</table>\n{{if data.count>0}}\n<footer class="footer bg-white b-t m-t-sm" data-type="ajaxPage">\n  <div class="row text-center-xs">\n    <div class="col-md-6 hidden-sm">\n      <p class="text-muted m-t">总共{{data.count}}条 当前为第{{data.currentPage}}页</p>\n    </div>\n    <div class="col-md-6 col-sm-12 text-right text-center-xs">\n      <ul class="pagination pagination-sm m-t-sm m-b-none" data-apages-total="{{data.totalPage}}" data-apage-current="{{data.currentPage}}">\n\n        <li {{if data.currentPage==1}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="first" data-page-num="1"> <i class="fa fa-angle-double-left" title="第一页"></i>\n          </a>\n        </li>\n        <li {{if data.currentPage==1}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="prev" data-page-num="{{data.currentPage-1}}"> <i class="fa fa-angle-left" title="上一页"></i>\n          </a>\n        </li>\n        {{each data.pagelist as item}}\n        <li {{if data.currentPage==item}} class="active"{{/if}}>\n          <a href="javascript:;" data-page-num="{{item}}" data-page-isnum="true">{{item}}</a>\n        </li>\n        {{/each}}\n        <li {{if data.currentPage==data.totalPage}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="next" data-page-num="{{data.currentPage+1}}">\n            <i class="fa fa-angle-right" title="下一页"></i>\n          </a>\n        </li>\n        <li {{if data.currentPage==data.totalPage}} class="disabled"{{/if}}>\n          <a href="javascript:;" rel="last" data-page-num="{{data.totalPage}}">\n            <i class="fa fa-angle-double-right" title="最后页" ></i>\n          </a>\n        </li>\n      </ul>\n    </div>\n  </div>\n</footer>\n{{/if}}\n</div>');